<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>从零开始搭建计算机 | Heavenhold</title><meta name="author" content="马洛"><meta name="copyright" content="马洛"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content=""><meta name="description" content="从零开始搭建计算机
 这个专题的主要内容是从最基础的与非门，一步步搭建出计算机的硬件结构，再到操作系统，最后实现一台可以运行任何想要程序的计算机。其中会涉及到编译器，虚拟机等等一系列知识。
 不多说，开始了。
 Step 1 Logic Gate
 以下共实现了 16 个逻辑门。
 Not
 // This file is part of www.nand2tetris.org// and the">
<meta property="og:type" content="article">
<meta property="og:title" content="从零开始搭建计算机">
<meta property="og:url" content="https://www.heavenhold.cn/posts/b6a9f85a.html">
<meta property="og:site_name" content="Heavenhold">
<meta property="og:description" content="从零开始搭建计算机
 这个专题的主要内容是从最基础的与非门，一步步搭建出计算机的硬件结构，再到操作系统，最后实现一台可以运行任何想要程序的计算机。其中会涉及到编译器，虚拟机等等一系列知识。
 不多说，开始了。
 Step 1 Logic Gate
 以下共实现了 16 个逻辑门。
 Not
 // This file is part of www.nand2tetris.org// and the">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410072124051.webp">
<meta property="article:published_time" content="2024-11-05T01:59:00.000Z">
<meta property="article:modified_time" content="2024-11-05T02:03:04.652Z">
<meta property="article:author" content="马洛">
<meta property="article:tag" content="计算机体系结构">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410072124051.webp"><link rel="shortcut icon" href="https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202408111410735.webp"><link rel="canonical" href="https://www.heavenhold.cn/posts/b6a9f85a.html"><link rel="preconnect" href="//cdn.jsdelivr.net"><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""><link rel="preconnect" href="//busuanzi.ibruce.info"><link rel="stylesheet" href="/css/index.css?v=4.13.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.5.1/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: undefined,
  noticeOutdate: {"limitDay":365,"position":"top","messagePrev":"It has been","messageNext":"days since the last update, the content of the article may be outdated."},
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":false,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: true
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体中文","cht_to_chs":"你已切换为简体中文","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#2d3035","position":"bottom-left"},
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid@4.11.1/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: true,
  },
  autoDarkmode: true
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '从零开始搭建计算机',
  isPost: true,
  isHome: false,
  isHighlightShrink: true,
  isToc: true,
  postUpdate: '2024-11-05 10:03:04'
}</script><script>(win=>{
      win.saveToLocal = {
        set: (key, value, ttl) => {
          if (ttl === 0) return
          const now = Date.now()
          const expiry = now + ttl * 86400000
          const item = {
            value,
            expiry
          }
          localStorage.setItem(key, JSON.stringify(item))
        },
      
        get: key => {
          const itemStr = localStorage.getItem(key)
      
          if (!itemStr) {
            return undefined
          }
          const item = JSON.parse(itemStr)
          const now = Date.now()
      
          if (now > item.expiry) {
            localStorage.removeItem(key)
            return undefined
          }
          return item.value
        }
      }
    
      win.getScript = (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        script.onerror = reject
        script.onload = script.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          script.onload = script.onreadystatechange = null
          resolve()
        }

        Object.keys(attr).forEach(key => {
          script.setAttribute(key, attr[key])
        })

        document.head.appendChild(script)
      })
    
      win.getCSS = (url, id = false) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onerror = reject
        link.onload = link.onreadystatechange = function() {
          const loadState = this.readyState
          if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
          link.onload = link.onreadystatechange = null
          resolve()
        }
        document.head.appendChild(link)
      })
    
      win.activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          const isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
          const isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
          const isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
          const hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

          if (t === undefined) {
            if (isLightMode) activateLightMode()
            else if (isDarkMode) activateDarkMode()
            else if (isNotSpecified || hasNoSupport) {
              const now = new Date()
              const hour = now.getHours()
              const isNight = hour <= 7 || hour >= 19
              isNight ? activateDarkMode() : activateLightMode()
            }
            window.matchMedia('(prefers-color-scheme: dark)').addListener(e => {
              if (saveToLocal.get('theme') === undefined) {
                e.matches ? activateDarkMode() : activateLightMode()
              }
            })
          } else if (t === 'light') activateLightMode()
          else activateDarkMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
      const detectApple = () => {
        if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
          document.documentElement.classList.add('apple')
        }
      }
      detectApple()
    })(window)</script><link rel="stylesheet" href="/css/universe.css"><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="/css/font.css"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiperstyle.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-double-row-display@1.00/cardlistpost.min.css">
<style>#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags:before {content:"\A";
  white-space: pre;}#recent-posts > .recent-post-item >.recent-post-info > .article-meta-wrap > .tags > .article-meta__separator{display:none}</style>
<!-- hexo injector head_end end --><meta name="generator" content="Hexo 7.1.1"><link href="https://cdn.bootcss.com/KaTeX/0.11.1/katex.min.css" rel="stylesheet"></head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://cdn.jsdelivr.net/gh/BomLook/blog-pic@main/img/202408111411832.webp" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">153</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">33</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">28</div></a></div><hr class="custom-hr"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410072124051.webp')"><nav id="nav"><span id="blog-info"><a href="/" title="Heavenhold"><span class="site-name">Heavenhold</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fas fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fa-fw fas fa-list"></i><span> List</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/music/"><i class="fa-fw fas fa-music"></i><span> Music</span></a></li><li><a class="site-page child" href="/movies/"><i class="fa-fw fas fa-video"></i><span> Movie</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);" rel="external nofollow noreferrer"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">从零开始搭建计算机</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-11-05T01:59:00.000Z" title="发表于 2024-11-05 09:59:00">2024-11-05</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-11-05T02:03:04.652Z" title="更新于 2024-11-05 10:03:04">2024-11-05</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">计算机体系结构</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">16.7k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>98分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="从零开始搭建计算机"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="从零开始搭建计算机">从零开始搭建计算机</h1>
<p>这个专题的主要内容是从最基础的与非门，一步步搭建出计算机的硬件结构，再到操作系统，最后实现一台可以运行任何想要程序的计算机。其中会涉及到编译器，虚拟机等等一系列知识。</p>
<p>不多说，开始了。</p>
<h2 id="step-1-logic-gate">Step 1 Logic Gate</h2>
<p>以下共实现了 16 个逻辑门。</p>
<h3 id="not">Not</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/<span class="keyword">Not</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Not gate:</span></span><br><span class="line"><span class="comment"> * if (in) out = 0, else out = 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="keyword">Not</span> {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Nand</span>(a = <span class="keyword">in</span>, b = <span class="keyword">in</span>, <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="and">And</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/<span class="keyword">And</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * And gate:</span></span><br><span class="line"><span class="comment"> * if (a and b) out = 1, else out = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="keyword">And</span> {</span><br><span class="line">    <span class="keyword">IN</span> a, b;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Nand</span>(a = a, b = b, <span class="keyword">out</span> = temp);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = temp, <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="or">Or</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/<span class="keyword">Or</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Or gate:</span></span><br><span class="line"><span class="comment"> * if (a or b) out = 1, else out = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="keyword">Or</span> {</span><br><span class="line">    <span class="keyword">IN</span> a, b;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = a, <span class="keyword">out</span> = nota);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = b, <span class="keyword">out</span> = notb);</span><br><span class="line">    <span class="keyword">Nand</span>(a = nota, b = notb, <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="xor">Xor</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/<span class="keyword">Xor</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Exclusive-or gate:</span></span><br><span class="line"><span class="comment"> * if ((a and Not(b)) or (Not(a) and b)) out = 1, else out = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="keyword">Xor</span> {</span><br><span class="line">    <span class="keyword">IN</span> a, b;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = a, <span class="keyword">out</span> = nota);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = b, <span class="keyword">out</span> = notb);</span><br><span class="line">    <span class="keyword">And</span>(a = nota, b = b, <span class="keyword">out</span> = temp1);</span><br><span class="line">    <span class="keyword">And</span>(a = a, b = notb, <span class="keyword">out</span> = temp2);</span><br><span class="line">    <span class="keyword">Or</span>(a = temp1, b = temp2, <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="mux">Mux</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Mux.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Multiplexor:</span></span><br><span class="line"><span class="comment"> * if (sel = 0) out = a, else out = b</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Mux {</span><br><span class="line">    <span class="keyword">IN</span> a, b, sel;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = sel, <span class="keyword">out</span> = notSel);</span><br><span class="line">    <span class="keyword">And</span>(a = a, b = notSel, <span class="keyword">out</span> = temp1);</span><br><span class="line">    <span class="keyword">And</span>(a = b, b = sel, <span class="keyword">out</span> = temp2);</span><br><span class="line">    <span class="keyword">Or</span>(a = temp1, b = temp2, <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dmux">DMux</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/DMux.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Demultiplexor:</span></span><br><span class="line"><span class="comment"> * [a, b] = [in, 0] if sel = 0</span></span><br><span class="line"><span class="comment"> *          [0, in] if sel = 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP DMux {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>, sel;</span><br><span class="line">    <span class="keyword">OUT</span> a, b;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = sel, <span class="keyword">out</span> = notSel);</span><br><span class="line">    <span class="keyword">And</span>(a = <span class="keyword">in</span>, b = notSel, <span class="keyword">out</span> = a);</span><br><span class="line">    <span class="keyword">And</span>(a = <span class="keyword">in</span>, b = sel, <span class="keyword">out</span> = b);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="not16">Not16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">01</span>/Not16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit Not gate:</span></span><br><span class="line"><span class="comment"> * for i = 0, ..., 15:</span></span><br><span class="line"><span class="comment"> * out[i] = Not(a[i])</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Not16 {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">0</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">1</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">2</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">3</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">4</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">5</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">6</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">6</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">7</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">7</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">8</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">8</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">9</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">9</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">10</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">10</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">11</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">11</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">12</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">12</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">13</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">13</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">14</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">14</span>]);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span> = <span class="keyword">in</span>[<span class="number">15</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">15</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="and16">And16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/And16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit And gate:</span></span><br><span class="line"><span class="comment"> * for i = 0, ..., 15:</span></span><br><span class="line"><span class="comment"> * out[i] = a[i] And b[i]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP And16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">0</span>], b = b[<span class="number">0</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">1</span>], b = b[<span class="number">1</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">2</span>], b = b[<span class="number">2</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">3</span>], b = b[<span class="number">3</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">4</span>], b = b[<span class="number">4</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">5</span>], b = b[<span class="number">5</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">6</span>], b = b[<span class="number">6</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">6</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">7</span>], b = b[<span class="number">7</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">7</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">8</span>], b = b[<span class="number">8</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">8</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">9</span>], b = b[<span class="number">9</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">9</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">10</span>], b = b[<span class="number">10</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">10</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">11</span>], b = b[<span class="number">11</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">11</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">12</span>], b = b[<span class="number">12</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">12</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">13</span>], b = b[<span class="number">13</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">13</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">14</span>], b = b[<span class="number">14</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">14</span>]);</span><br><span class="line">    <span class="keyword">And</span>(a = a[<span class="number">15</span>], b = b[<span class="number">15</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">15</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="or16">Or16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Or16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit Or gate:</span></span><br><span class="line"><span class="comment"> * for i = 0, ..., 15:</span></span><br><span class="line"><span class="comment"> * out[i] = a[i] Or b[i]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Or16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">0</span>], b = b[<span class="number">0</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">1</span>], b = b[<span class="number">1</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">2</span>], b = b[<span class="number">2</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">2</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">3</span>], b = b[<span class="number">3</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">3</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">4</span>], b = b[<span class="number">4</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">4</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">5</span>], b = b[<span class="number">5</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">5</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">6</span>], b = b[<span class="number">6</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">6</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">7</span>], b = b[<span class="number">7</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">7</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">8</span>], b = b[<span class="number">8</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">8</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">9</span>], b = b[<span class="number">9</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">9</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">10</span>], b = b[<span class="number">10</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">10</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">11</span>], b = b[<span class="number">11</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">11</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">12</span>], b = b[<span class="number">12</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">12</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">13</span>], b = b[<span class="number">13</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">13</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">14</span>], b = b[<span class="number">14</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">14</span>]);</span><br><span class="line">    <span class="keyword">Or</span>(a = a[<span class="number">15</span>], b = b[<span class="number">15</span>], <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">15</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="mux16">Mux16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Mux16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit multiplexor:</span></span><br><span class="line"><span class="comment"> * for i = 0, ..., 15:</span></span><br><span class="line"><span class="comment"> * if (sel = 0) out[i] = a[i], else out[i] = b[i]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Mux16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>], sel;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux(a = a[<span class="number">0</span>], b = b[<span class="number">0</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">0</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">1</span>], b = b[<span class="number">1</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">1</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">2</span>], b = b[<span class="number">2</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">2</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">3</span>], b = b[<span class="number">3</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">3</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">4</span>], b = b[<span class="number">4</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">4</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">5</span>], b = b[<span class="number">5</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">5</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">6</span>], b = b[<span class="number">6</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">6</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">7</span>], b = b[<span class="number">7</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">7</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">8</span>], b = b[<span class="number">8</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">8</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">9</span>], b = b[<span class="number">9</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">9</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">10</span>], b = b[<span class="number">10</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">10</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">11</span>], b = b[<span class="number">11</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">11</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">12</span>], b = b[<span class="number">12</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">12</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">13</span>], b = b[<span class="number">13</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">13</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">14</span>], b = b[<span class="number">14</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">14</span>]);</span><br><span class="line">    Mux(a = a[<span class="number">15</span>], b = b[<span class="number">15</span>], sel = sel, <span class="keyword">out</span> = <span class="keyword">out</span>[<span class="number">15</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="or8way">Or8Way</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Or8Way.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 8-way Or gate:</span></span><br><span class="line"><span class="comment"> * out = in[0] Or in[1] Or ... Or in[7]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Or8Way {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">8</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Or</span>(a = <span class="keyword">in</span>[<span class="number">0</span>], b = <span class="keyword">in</span>[<span class="number">1</span>], <span class="keyword">out</span> = t01);</span><br><span class="line">    <span class="keyword">Or</span>(a = t01, b = <span class="keyword">in</span>[<span class="number">2</span>], <span class="keyword">out</span> = t02);</span><br><span class="line">    <span class="keyword">Or</span>(a = t02, b = <span class="keyword">in</span>[<span class="number">3</span>], <span class="keyword">out</span> = t03);</span><br><span class="line">    <span class="keyword">Or</span>(a = t03, b = <span class="keyword">in</span>[<span class="number">4</span>], <span class="keyword">out</span> = t04);</span><br><span class="line">    <span class="keyword">Or</span>(a = t04, b = <span class="keyword">in</span>[<span class="number">5</span>], <span class="keyword">out</span> = t05);</span><br><span class="line">    <span class="keyword">Or</span>(a = t05, b = <span class="keyword">in</span>[<span class="number">6</span>], <span class="keyword">out</span> = t06);</span><br><span class="line">    <span class="keyword">Or</span>(a = t06, b = <span class="keyword">in</span>[<span class="number">7</span>], <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="mux4way16">Mux4Way16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Mux4Way16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 4-way 16-bit multiplexor:</span></span><br><span class="line"><span class="comment"> * out = a if sel = 00</span></span><br><span class="line"><span class="comment"> *       b if sel = 01</span></span><br><span class="line"><span class="comment"> *       c if sel = 10</span></span><br><span class="line"><span class="comment"> *       d if sel = 11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Mux4Way16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>], c[<span class="number">16</span>], d[<span class="number">16</span>], sel[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux16(a = a, b = c, sel = sel[<span class="number">1</span>], <span class="keyword">out</span> = temp1);</span><br><span class="line">    Mux16(a = b, b = d, sel = sel[<span class="number">1</span>], <span class="keyword">out</span> = temp2);</span><br><span class="line">    Mux16(a = temp1, b = temp2, sel = sel[<span class="number">0</span>], <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="mux8way16">Mux8Way16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/Mux8Way16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 8-way 16-bit multiplexor:</span></span><br><span class="line"><span class="comment"> * out = a if sel = 000</span></span><br><span class="line"><span class="comment"> *       b if sel = 001</span></span><br><span class="line"><span class="comment"> *       c if sel = 010</span></span><br><span class="line"><span class="comment"> *       d if sel = 011</span></span><br><span class="line"><span class="comment"> *       e if sel = 100</span></span><br><span class="line"><span class="comment"> *       f if sel = 101</span></span><br><span class="line"><span class="comment"> *       g if sel = 110</span></span><br><span class="line"><span class="comment"> *       h if sel = 111</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Mux8Way16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>], c[<span class="number">16</span>], d[<span class="number">16</span>],</span><br><span class="line">       e[<span class="number">16</span>], f[<span class="number">16</span>], g[<span class="number">16</span>], h[<span class="number">16</span>],</span><br><span class="line">       sel[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux16(a = a, b = b, sel = sel[<span class="number">0</span>], <span class="keyword">out</span> = temp1);</span><br><span class="line">    Mux16(a = c, b = d, sel = sel[<span class="number">0</span>], <span class="keyword">out</span> = temp2);</span><br><span class="line">    Mux16(a = e, b = f, sel = sel[<span class="number">0</span>], <span class="keyword">out</span> = temp3);</span><br><span class="line">    Mux16(a = g, b = h, sel = sel[<span class="number">0</span>], <span class="keyword">out</span> = temp4);</span><br><span class="line">    Mux16(a = temp1, b = temp2, sel = sel[<span class="number">1</span>], <span class="keyword">out</span> = final0);</span><br><span class="line">    Mux16(a = temp3, b = temp4, sel = sel[<span class="number">1</span>], <span class="keyword">out</span> = final1);</span><br><span class="line">    Mux16(a = final0, b = final1, sel = sel[<span class="number">2</span>], <span class="keyword">out</span> = <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dmux4way16">DMux4Way16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/DMux4Way.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 4-way demultiplexor:</span></span><br><span class="line"><span class="comment"> * [a, b, c, d] = [in, 0, 0, 0] if sel = 00</span></span><br><span class="line"><span class="comment"> *                [0, in, 0, 0] if sel = 01</span></span><br><span class="line"><span class="comment"> *                [0, 0, in, 0] if sel = 10</span></span><br><span class="line"><span class="comment"> *                [0, 0, 0, in] if sel = 11</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP DMux4Way {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>, sel[<span class="number">2</span>];</span><br><span class="line">    <span class="keyword">OUT</span> a, b, c, d;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux(<span class="keyword">in</span> = <span class="keyword">in</span>, sel = sel[<span class="number">1</span>], a = temp1, b = temp2);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp1, sel = sel[<span class="number">0</span>], a = a, b = b);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp2, sel = sel[<span class="number">0</span>], a = c, b = d);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="dmux8way">DMux8Way</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">1</span>/DMux8Way.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 8-way demultiplexor:</span></span><br><span class="line"><span class="comment"> * [a, b, c, d, e, f, g, h] = [in, 0,  0,  0,  0,  0,  0,  0] if sel = 000</span></span><br><span class="line"><span class="comment"> *                            [0, in,  0,  0,  0,  0,  0,  0] if sel = 001</span></span><br><span class="line"><span class="comment"> *                            [0,  0, in,  0,  0,  0,  0,  0] if sel = 010</span></span><br><span class="line"><span class="comment"> *                            [0,  0,  0, in,  0,  0,  0,  0] if sel = 011</span></span><br><span class="line"><span class="comment"> *                            [0,  0,  0,  0, in,  0,  0,  0] if sel = 100</span></span><br><span class="line"><span class="comment"> *                            [0,  0,  0,  0,  0, in,  0,  0] if sel = 101</span></span><br><span class="line"><span class="comment"> *                            [0,  0,  0,  0,  0,  0, in,  0] if sel = 110</span></span><br><span class="line"><span class="comment"> *                            [0,  0,  0,  0,  0,  0,  0, in] if sel = 111</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP DMux8Way {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>, sel[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">OUT</span> a, b, c, d, e, f, g, h;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux(<span class="keyword">in</span> = <span class="keyword">in</span>, sel = sel[<span class="number">2</span>], a = temp1, b = temp2);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp1, sel = sel[<span class="number">1</span>], a = temp3, b = temp4);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp2, sel = sel[<span class="number">1</span>], a = temp5, b = temp6);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp3, sel = sel[<span class="number">0</span>], a = a, b = b);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp4, sel = sel[<span class="number">0</span>], a = c, b = d);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp5, sel = sel[<span class="number">0</span>], a = e, b = f);</span><br><span class="line">    DMux(<span class="keyword">in</span> = temp6, sel = sel[<span class="number">0</span>], a = g, b = h);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-2-a-simple-alu">Step 2 A Simple ALU</h2>
<p>以下是搭建一个简单的 ALU，相比于计组学习到的简单很多。</p>
<h3 id="halfadder">HalfAdder</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">2</span>/HalfAdder.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Computes the sum of two bits.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP HalfAdder {</span><br><span class="line">    <span class="keyword">IN</span> a, b;    // <span class="number">1</span>-<span class="built_in">bit</span> inputs</span><br><span class="line">    <span class="keyword">OUT</span> sum,    // Right <span class="built_in">bit</span> <span class="keyword">of</span> a + b</span><br><span class="line">        carry;  // Left <span class="built_in">bit</span> <span class="keyword">of</span> a + b</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Xor</span>(a = a, b = b, <span class="keyword">out</span> = sum);</span><br><span class="line">    <span class="keyword">And</span>(a = a, b = b, <span class="keyword">out</span> = carry);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="fulladder">FullAdder</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">2</span>/FullAdder.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Computes the sum of three bits.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP FullAdder {</span><br><span class="line">    <span class="keyword">IN</span> a, b, c;  // <span class="number">1</span>-<span class="built_in">bit</span> inputs</span><br><span class="line">    <span class="keyword">OUT</span> sum,     // Right <span class="built_in">bit</span> <span class="keyword">of</span> a + b + c</span><br><span class="line">        carry;   // Left <span class="built_in">bit</span> <span class="keyword">of</span> a + b + c</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="keyword">Xor</span>(a = a, b = b, <span class="keyword">out</span> = axorb);</span><br><span class="line">    <span class="keyword">Xor</span>(a = axorb, b = c, <span class="keyword">out</span> = sum);</span><br><span class="line">    <span class="keyword">And</span>(a = a, b = b, <span class="keyword">out</span> = temp1);</span><br><span class="line">    <span class="keyword">And</span>(a = a, b = c, <span class="keyword">out</span> = temp2);</span><br><span class="line">    <span class="keyword">And</span>(a = b, b = c, <span class="keyword">out</span> = temp3);</span><br><span class="line">    <span class="keyword">Or</span>(a = temp1, b = temp2, <span class="keyword">out</span> = temp4);</span><br><span class="line">    <span class="keyword">Or</span>(a = temp4, b = temp3, <span class="keyword">out</span> = carry);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="add16">Add16</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">2</span>/Add16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit adder: Adds two 16-bit two's complement values.</span></span><br><span class="line"><span class="comment"> * The most significant carry bit is ignored.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Add16 {</span><br><span class="line">    <span class="keyword">IN</span> a[<span class="number">16</span>], b[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    HalfAdder(a= a[<span class="number">0</span>], b= b[<span class="number">0</span>], sum= <span class="keyword">out</span>[<span class="number">0</span>], carry= t0);</span><br><span class="line">    FullAdder(a= a[<span class="number">1</span>], b= b[<span class="number">1</span>], c= t0, sum= <span class="keyword">out</span>[<span class="number">1</span>], carry= t1);</span><br><span class="line">    FullAdder(a= a[<span class="number">2</span>], b= b[<span class="number">2</span>], c= t1, sum= <span class="keyword">out</span>[<span class="number">2</span>], carry= t2);</span><br><span class="line">    FullAdder(a= a[<span class="number">3</span>], b= b[<span class="number">3</span>], c= t2, sum= <span class="keyword">out</span>[<span class="number">3</span>], carry= t3);</span><br><span class="line">    FullAdder(a= a[<span class="number">4</span>], b= b[<span class="number">4</span>], c= t3, sum= <span class="keyword">out</span>[<span class="number">4</span>], carry= t4);</span><br><span class="line">    FullAdder(a= a[<span class="number">5</span>], b= b[<span class="number">5</span>], c= t4, sum= <span class="keyword">out</span>[<span class="number">5</span>], carry= t5);</span><br><span class="line">    FullAdder(a= a[<span class="number">6</span>], b= b[<span class="number">6</span>], c= t5, sum= <span class="keyword">out</span>[<span class="number">6</span>], carry= t6);</span><br><span class="line">    FullAdder(a= a[<span class="number">7</span>], b= b[<span class="number">7</span>], c= t6, sum= <span class="keyword">out</span>[<span class="number">7</span>], carry= t7);</span><br><span class="line">    FullAdder(a= a[<span class="number">8</span>], b= b[<span class="number">8</span>], c= t7, sum= <span class="keyword">out</span>[<span class="number">8</span>], carry= t8);</span><br><span class="line">    FullAdder(a= a[<span class="number">9</span>], b= b[<span class="number">9</span>], c= t8, sum= <span class="keyword">out</span>[<span class="number">9</span>], carry= t9);</span><br><span class="line">    FullAdder(a= a[<span class="number">10</span>], b= b[<span class="number">10</span>], c= t9, sum= <span class="keyword">out</span>[<span class="number">10</span>], carry= t10);</span><br><span class="line">    FullAdder(a= a[<span class="number">11</span>], b= b[<span class="number">11</span>], c= t10, sum= <span class="keyword">out</span>[<span class="number">11</span>], carry= t11);</span><br><span class="line">    FullAdder(a= a[<span class="number">12</span>], b= b[<span class="number">12</span>], c= t11, sum= <span class="keyword">out</span>[<span class="number">12</span>], carry= t12);</span><br><span class="line">    FullAdder(a= a[<span class="number">13</span>], b= b[<span class="number">13</span>], c= t12, sum= <span class="keyword">out</span>[<span class="number">13</span>], carry= t13);</span><br><span class="line">    FullAdder(a= a[<span class="number">14</span>], b= b[<span class="number">14</span>], c= t13, sum= <span class="keyword">out</span>[<span class="number">14</span>], carry= t14);</span><br><span class="line">    FullAdder(a= a[<span class="number">15</span>], b= b[<span class="number">15</span>], c= t14, sum= <span class="keyword">out</span>[<span class="number">15</span>], carry= t15);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="inc16">Inc16</h3>
<p>自增</p>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">2</span>/Inc16.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit incrementer:</span></span><br><span class="line"><span class="comment"> * out = in + 1</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Inc16 {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    HalfAdder(a= <span class="keyword">in</span>[<span class="number">0</span>], b= <span class="literal">true</span>, sum= <span class="keyword">out</span>[<span class="number">0</span>], carry= t0);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">1</span>], b= <span class="literal">false</span>, c= t0, sum= <span class="keyword">out</span>[<span class="number">1</span>], carry= t1);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">2</span>], b= <span class="literal">false</span>, c= t1, sum= <span class="keyword">out</span>[<span class="number">2</span>], carry= t2);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">3</span>], b= <span class="literal">false</span>, c= t2, sum= <span class="keyword">out</span>[<span class="number">3</span>], carry= t3);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">4</span>], b= <span class="literal">false</span>, c= t3, sum= <span class="keyword">out</span>[<span class="number">4</span>], carry= t4);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">5</span>], b= <span class="literal">false</span>, c= t4, sum= <span class="keyword">out</span>[<span class="number">5</span>], carry= t5);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">6</span>], b= <span class="literal">false</span>, c= t5, sum= <span class="keyword">out</span>[<span class="number">6</span>], carry= t6);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">7</span>], b= <span class="literal">false</span>, c= t6, sum= <span class="keyword">out</span>[<span class="number">7</span>], carry= t7);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">8</span>], b= <span class="literal">false</span>, c= t7, sum= <span class="keyword">out</span>[<span class="number">8</span>], carry= t8);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">9</span>], b= <span class="literal">false</span>, c= t8, sum= <span class="keyword">out</span>[<span class="number">9</span>], carry= t9);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">10</span>], b= <span class="literal">false</span>, c= t9, sum= <span class="keyword">out</span>[<span class="number">10</span>], carry= t10);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">11</span>], b= <span class="literal">false</span>, c= t10, sum= <span class="keyword">out</span>[<span class="number">11</span>], carry= t11);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">12</span>], b= <span class="literal">false</span>, c= t11, sum= <span class="keyword">out</span>[<span class="number">12</span>], carry= t12);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">13</span>], b= <span class="literal">false</span>, c= t12, sum= <span class="keyword">out</span>[<span class="number">13</span>], carry= t13);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">14</span>], b= <span class="literal">false</span>, c= t13, sum= <span class="keyword">out</span>[<span class="number">14</span>], carry= t14);</span><br><span class="line">    FullAdder(a= <span class="keyword">in</span>[<span class="number">15</span>], b= <span class="literal">false</span>, c= t14, sum= <span class="keyword">out</span>[<span class="number">15</span>], carry= t15);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="alu">ALU</h3>
<p>搭建 ALU
这里比较麻烦，因为<code>zr</code>和<code>ng</code>需要对每一位进行位运算。</p>
<p>这里有一个技巧，就是在计算<code>out</code>时，在表达式内重现命名<code>out[0..7] out[8..15]</code>，后面可以使用进行位运算。</p>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">2</span>/ALU.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ALU (Arithmetic Logic Unit):</span></span><br><span class="line"><span class="comment"> * Computes out = one of the following functions:</span></span><br><span class="line"><span class="comment"> *                0, 1, -1,</span></span><br><span class="line"><span class="comment"> *                x, y, !x, !y, -x, -y,</span></span><br><span class="line"><span class="comment"> *                x + 1, y + 1, x - 1, y - 1,</span></span><br><span class="line"><span class="comment"> *                x + y, x - y, y - x,</span></span><br><span class="line"><span class="comment"> *                x &amp; y, x | y</span></span><br><span class="line"><span class="comment"> * on the 16-bit inputs x, y,</span></span><br><span class="line"><span class="comment"> * according to the input bits zx, nx, zy, ny, f, no.</span></span><br><span class="line"><span class="comment"> * In addition, computes the two output bits:</span></span><br><span class="line"><span class="comment"> * if (out == 0) zr = 1, else zr = 0</span></span><br><span class="line"><span class="comment"> * if (out &lt; 0)  ng = 1, else ng = 0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">// Implementation: Manipulates the x <span class="keyword">and</span> y inputs</span><br><span class="line">// <span class="keyword">and</span> operates <span class="keyword">on</span> the resulting values, as follows:</span><br><span class="line">// <span class="keyword">if</span> (zx == <span class="number">1</span>) sets x = <span class="number">0</span>        // <span class="number">16</span>-<span class="built_in">bit</span> <span class="keyword">constant</span></span><br><span class="line">// <span class="keyword">if</span> (nx == <span class="number">1</span>) sets x = !x       // bitwise <span class="keyword">not</span></span><br><span class="line">// <span class="keyword">if</span> (zy == <span class="number">1</span>) sets y = <span class="number">0</span>        // <span class="number">16</span>-<span class="built_in">bit</span> <span class="keyword">constant</span></span><br><span class="line">// <span class="keyword">if</span> (ny == <span class="number">1</span>) sets y = !y       // bitwise <span class="keyword">not</span></span><br><span class="line">// <span class="keyword">if</span> (f == <span class="number">1</span>)  sets <span class="keyword">out</span> = x + y  // <span class="built_in">integer</span> <span class="number">2</span><span class="symbol">'s</span> complement addition</span><br><span class="line">// <span class="keyword">if</span> (f == <span class="number">0</span>)  sets <span class="keyword">out</span> = x &amp; y  // bitwise <span class="keyword">and</span></span><br><span class="line">// <span class="keyword">if</span> (no == <span class="number">1</span>) sets <span class="keyword">out</span> = !<span class="keyword">out</span>   // bitwise <span class="keyword">not</span></span><br><span class="line"></span><br><span class="line">CHIP ALU {</span><br><span class="line">    <span class="keyword">IN</span></span><br><span class="line">        x[<span class="number">16</span>], y[<span class="number">16</span>],  // <span class="number">16</span>-<span class="built_in">bit</span> inputs</span><br><span class="line">        zx, // zero the x input?</span><br><span class="line">        nx, // negate the x input?</span><br><span class="line">        zy, // zero the y input?</span><br><span class="line">        ny, // negate the y input?</span><br><span class="line">        f,  // compute (<span class="keyword">out</span> = x + y) <span class="keyword">or</span> (<span class="keyword">out</span> = x &amp; y)?</span><br><span class="line">        no; // negate the <span class="keyword">out</span> output?</span><br><span class="line">    <span class="keyword">OUT</span></span><br><span class="line">        <span class="keyword">out</span>[<span class="number">16</span>], // <span class="number">16</span>-<span class="built_in">bit</span> output</span><br><span class="line">        zr,      // <span class="keyword">if</span> (<span class="keyword">out</span> == <span class="number">0</span>) equals <span class="number">1</span>, <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line">        ng;      // <span class="keyword">if</span> (<span class="keyword">out</span> &lt; <span class="number">0</span>)  equals <span class="number">1</span>, <span class="keyword">else</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux16(a= x, b= <span class="literal">false</span>, sel= zx, <span class="keyword">out</span>= temp1);</span><br><span class="line">    Not16(<span class="keyword">in</span>= temp1, <span class="keyword">out</span>= notx);</span><br><span class="line">    Mux16(a= temp1, b= notx, sel= nx, <span class="keyword">out</span>= temp2);</span><br><span class="line"></span><br><span class="line">    Mux16(a= y, b= <span class="literal">false</span>, sel= zy, <span class="keyword">out</span>= temp3);</span><br><span class="line">    Not16(<span class="keyword">in</span>= temp3, <span class="keyword">out</span>= noty);</span><br><span class="line">    Mux16(a= temp3, b= noty, sel= ny, <span class="keyword">out</span>= temp4);</span><br><span class="line"></span><br><span class="line">    Add16(a = temp2, b = temp4, <span class="keyword">out</span> = aPlusb);</span><br><span class="line">    And16(a= temp2, b= temp4, <span class="keyword">out</span>= aAndb);</span><br><span class="line">    Mux16(a= aAndb, b= aPlusb, sel= f, <span class="keyword">out</span>= temp5);</span><br><span class="line"></span><br><span class="line">    Not16(<span class="keyword">in</span>= temp5, <span class="keyword">out</span>= temp6);</span><br><span class="line">    Mux16(a= temp5, b= temp6, sel= no, <span class="keyword">out</span>= <span class="keyword">out</span>, <span class="keyword">out</span>[<span class="number">0</span>..<span class="number">7</span>]= low, <span class="keyword">out</span>[<span class="number">8</span>..<span class="number">15</span>]=high, <span class="keyword">out</span>[<span class="number">15</span>]= MSB);</span><br><span class="line"></span><br><span class="line">    Or8Way(<span class="keyword">in</span>= low, <span class="keyword">out</span>= t1);</span><br><span class="line">    Or8Way(<span class="keyword">in</span>= high, <span class="keyword">out</span>= t2);</span><br><span class="line">    <span class="keyword">Or</span>(a= t1, b= t2, <span class="keyword">out</span> = t0);</span><br><span class="line">    Mux(a= <span class="literal">true</span>, b= <span class="literal">false</span>, sel= t0, <span class="keyword">out</span>= zr);</span><br><span class="line">    Mux(a= <span class="literal">false</span>, b= <span class="literal">true</span>, sel= MSB, <span class="keyword">out</span>= ng);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-3-memory">Step 3 Memory</h2>
<h3 id="bit">Bit</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/a/<span class="built_in">Bit</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 1-bit register:</span></span><br><span class="line"><span class="comment"> * If load is asserted, the register's value is set to in;</span></span><br><span class="line"><span class="comment"> * Otherwise, the register maintains its current value:</span></span><br><span class="line"><span class="comment"> * if (load(t)) out(t+1) = in(t), else out(t+1) = out(t)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="built_in">Bit</span> {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>, load;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux(a= temp, b= <span class="keyword">in</span>, sel= load, <span class="keyword">out</span>= temp0);</span><br><span class="line">    DFF(<span class="keyword">in</span>= temp0, <span class="keyword">out</span>= <span class="keyword">out</span>, <span class="keyword">out</span>= temp);</span><br><span class="line">    //<span class="keyword">out</span>= <span class="keyword">out</span> 负责输出</span><br><span class="line">    //<span class="keyword">out</span>= temp 负责拉回输入</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="register">Register</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/a/<span class="keyword">Register</span>.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 16-bit register:</span></span><br><span class="line"><span class="comment"> * If load is asserted, the register's value is set to in;</span></span><br><span class="line"><span class="comment"> * Otherwise, the register maintains its current value:</span></span><br><span class="line"><span class="comment"> * if (load(t)) out(t+1) = in(t), else out(t+1) = out(t)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP <span class="keyword">Register</span> {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">0</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">1</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">1</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">2</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">3</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">3</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">4</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">4</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">5</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">5</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">6</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">6</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">7</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">7</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">8</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">8</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">9</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">9</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">10</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">10</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">11</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">11</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">12</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">12</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">13</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">13</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">14</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">14</span>]);</span><br><span class="line">    <span class="built_in">Bit</span>(<span class="keyword">in</span>= <span class="keyword">in</span>[<span class="number">15</span>], load= load, <span class="keyword">out</span>= <span class="keyword">out</span>[<span class="number">15</span>]);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ram8">RAM8</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/a/RAM8.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memory of eight 16-bit registers.</span></span><br><span class="line"><span class="comment"> * If load is asserted, the value of the register selected by</span></span><br><span class="line"><span class="comment"> * address is set to in; Otherwise, the value does not change.</span></span><br><span class="line"><span class="comment"> * The value of the selected register is emitted by out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP RAM8 {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">3</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line"></span><br><span class="line">    //<span class="number">8</span>个对于<span class="number">8</span>个编号，利用编号找到对应的<span class="keyword">Register</span>，对应<span class="number">8</span>个信号值</span><br><span class="line">    DMux8Way(<span class="keyword">in</span>=load, sel=address, a=load0, b=load1, c=load2, d=load3, e=load4, f=load5, g=load6, h=load7);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load0, <span class="keyword">out</span>=o1);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load1, <span class="keyword">out</span>=o2);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load2, <span class="keyword">out</span>=o3);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load3, <span class="keyword">out</span>=o4);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load4, <span class="keyword">out</span>=o5);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load5, <span class="keyword">out</span>=o6);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load6, <span class="keyword">out</span>=o7);</span><br><span class="line">	<span class="keyword">Register</span>(<span class="keyword">in</span>=<span class="keyword">in</span>, load=load7, <span class="keyword">out</span>=o8);</span><br><span class="line"></span><br><span class="line">	Mux8Way16(a=o1, b=o2, c=o3, d=o4, e=o5, f=o6, g=o7, h=o8, sel=address, <span class="keyword">out</span>=<span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ram64">RAM64</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/a/RAM64.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memory of sixty four 16-bit registers.</span></span><br><span class="line"><span class="comment"> * If load is asserted, the value of the register selected by</span></span><br><span class="line"><span class="comment"> * address is set to in; Otherwise, the value does not change.</span></span><br><span class="line"><span class="comment"> * The value of the selected register is emitted by out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP RAM64 {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">6</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux8Way(<span class="keyword">in</span>= load, sel= address[<span class="number">0</span>..<span class="number">2</span>], a= load0, b= load1, c= load2, d= load3, e= load4, f= load5, g= load6, h= load7);</span><br><span class="line"></span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load0, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o0);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load1, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o1);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load2, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o2);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load3, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o3);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load4, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o4);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load5, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o5);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load6, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o6);</span><br><span class="line">    RAM8(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load7, address= address[<span class="number">3</span>..<span class="number">5</span>], <span class="keyword">out</span>= o7);</span><br><span class="line"></span><br><span class="line">    Mux8Way16(a= o0, b= o1, c= o2, d= o3, e= o4, f= o5, g= o6, h= o7, sel= address[<span class="number">0</span>..<span class="number">2</span>], <span class="keyword">out</span>= <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ram512">RAM512</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/b/RAM512.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memory of 512 16-bit registers.</span></span><br><span class="line"><span class="comment"> * If load is asserted, the value of the register selected by</span></span><br><span class="line"><span class="comment"> * address is set to in; Otherwise, the value does not change.</span></span><br><span class="line"><span class="comment"> * The value of the selected register is emitted by out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP RAM512 {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">9</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux8Way(<span class="keyword">in</span>= load, sel= address[<span class="number">0</span>..<span class="number">2</span>], a= load0, b= load1, c= load2, d= load3, e= load4, f= load5, g= load6, h= load7);</span><br><span class="line"></span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load0, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o0);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load1, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o1);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load2, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o2);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load3, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o3);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load4, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o4);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load5, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o5);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load6, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o6);</span><br><span class="line">    RAM64(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load7, address= address[<span class="number">3</span>..<span class="number">8</span>], <span class="keyword">out</span>= o7);</span><br><span class="line"></span><br><span class="line">    Mux8Way16(a= o0, b= o1, c= o2, d= o3, e= o4, f= o5, g= o6, h= o7, sel= address[<span class="number">0</span>..<span class="number">2</span>], <span class="keyword">out</span>= <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ram4k">RAM4K</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/b/RAM4K.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memory of 4K 16-bit registers.</span></span><br><span class="line"><span class="comment"> * If load is asserted, the value of the register selected by</span></span><br><span class="line"><span class="comment"> * address is set to in; Otherwise, the value does not change.</span></span><br><span class="line"><span class="comment"> * The value of the selected register is emitted by out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP RAM4K {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">12</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux8Way(<span class="keyword">in</span>= load, sel= address[<span class="number">0</span>..<span class="number">2</span>], a= load0, b= load1, c= load2, d= load3, e= load4, f= load5, g= load6, h= load7);</span><br><span class="line"></span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load0, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o0);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load1, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o1);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load2, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o2);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load3, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o3);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load4, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o4);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load5, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o5);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load6, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o6);</span><br><span class="line">    RAM512(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load7, address= address[<span class="number">3</span>..<span class="number">11</span>], <span class="keyword">out</span>= o7);</span><br><span class="line"></span><br><span class="line">    Mux8Way16(a= o0, b= o1, c= o2, d= o3, e= o4, f= o5, g= o6, h= o7, sel= address[<span class="number">0</span>..<span class="number">2</span>], <span class="keyword">out</span>= <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="ram16k">RAM16K</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/b/RAM16K.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Memory of 16K 16-bit registers.</span></span><br><span class="line"><span class="comment"> * If load is asserted, the value of the register selected by</span></span><br><span class="line"><span class="comment"> * address is set to in; Otherwise, the value does not change.</span></span><br><span class="line"><span class="comment"> * The value of the selected register is emitted by out.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP RAM16K {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">14</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux4Way(<span class="keyword">in</span>= load, sel= address[<span class="number">0</span>..<span class="number">1</span>], a= load0, b= load1, c= load2, d= load3);</span><br><span class="line"></span><br><span class="line">    RAM4K(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load0, address= address[<span class="number">2</span>..<span class="number">13</span>], <span class="keyword">out</span>= o0);</span><br><span class="line">    RAM4K(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load1, address= address[<span class="number">2</span>..<span class="number">13</span>], <span class="keyword">out</span>= o1);</span><br><span class="line">    RAM4K(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load2, address= address[<span class="number">2</span>..<span class="number">13</span>], <span class="keyword">out</span>= o2);</span><br><span class="line">    RAM4K(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load3, address= address[<span class="number">2</span>..<span class="number">13</span>], <span class="keyword">out</span>= o3);</span><br><span class="line"></span><br><span class="line">    Mux4Way16(a= o0, b= o1, c= o2, d= o3, sel= address[<span class="number">0</span>..<span class="number">1</span>], <span class="keyword">out</span>= <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="pc">PC</h3>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">3</span>/a/PC.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * A 16-bit counter.</span></span><br><span class="line"><span class="comment"> * if      reset(t): out(t+1) = 0</span></span><br><span class="line"><span class="comment"> * else if load(t):  out(t+1) = in(t)</span></span><br><span class="line"><span class="comment"> * else if inc(t):   out(t+1) = out(t) + 1</span></span><br><span class="line"><span class="comment"> * else              out(t+1) = out(t)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP PC {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], reset, load, inc;</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    Mux16(a= o3, b= o3add, sel= inc, <span class="keyword">out</span>= o0);</span><br><span class="line">    Mux16(a= o0, b= <span class="keyword">in</span>, sel= load, <span class="keyword">out</span>= o1);</span><br><span class="line">    Mux16(a= o1, b= <span class="literal">false</span>, sel= reset, <span class="keyword">out</span>= o2);</span><br><span class="line"></span><br><span class="line">    //可以先选择是哪一个为最终结果，然后巧用<span class="keyword">Register</span>, 我们保证传递值即可</span><br><span class="line">    <span class="keyword">Register</span>(<span class="keyword">in</span>= o2, load= <span class="literal">true</span>, <span class="keyword">out</span>= <span class="keyword">out</span>, <span class="keyword">out</span>= o3);</span><br><span class="line">    Inc16(<span class="keyword">in</span>= o3, <span class="keyword">out</span>= o3add);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-4-machine-language">Step 4 Machine Language</h2>
<p>可能涉及到的符号：</p>
<ul>
<li>D：数据寄存器。</li>
<li>A：数据/地址寄存器。</li>
<li>M：目前选中的寄存器。<code>M=RAM[A]</code>。</li>
</ul>
<p>主要涉到三种指令：</p>
<ul>
<li><p>A：</p>
<ul>
<li>符号：为<code>@value</code>，表示<code>A=value</code>，负责设置<code>RAM[A]</code>为<code>RAM[value]</code>，也可能当前选中的是<code>ROM[A]</code>。</li>
<li><code>RAM</code>和<code>ROM</code>的区别除了可读可写之外，还有存放的内容<code>RAM</code>存放的是数据，<code>ROM</code>存放的是指令。</li>
</ul></li>
<li><p>二进制：为<code>0value</code>，最高位表示操作码，剩下的十五位表示<code>value</code>。</p></li>
<li><p>M：<code>M</code>表示当前选定的<code>RAM[A]</code>。</p></li>
<li><p>C：</p>
<ul>
<li>符号：<code>dest = comp; jump</code>，<code>dest</code>表示目的操作数，<code>comp</code>表示计算结果，<code>jump</code>表示跳转指令选项。<code>dest = comp</code>将计算结果赋值给<code>dest</code>。</li>
</ul></li>
</ul>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410171648441.webp"></p>
<p>基础语法：</p>
<ul>
<li><code>reg</code>：0、-1、1。表示寄存器只能赋值这三个值。</li>
<li><code>reg1=reg2</code>：其中<code>reg1={A|D|M}</code>，<code>reg2=[-]{A|D|M}</code>。</li>
<li><code>reg = reg1 op reg2</code>：其中<code>reg,reg1={A|D|M}</code>，<code>reg2={A|D|M|1|0|-1}</code>，<code>op={+|-|&amp;||}</code>。</li>
</ul>
<p>控制：使用 A 指令选择一个地址，使用 C
指令进行跳转。常见类型如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410172150662.webp"></p>
<p><strong>e. g</strong>：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">// if(D&gt;0) goto 6</span><br><span class="line">@6</span><br><span class="line">D;JGT</span><br></pre></td></tr></tbody></table></figure>
<p>变量：使用语法<code>@sym</code>：表示将一个数字<code>i</code>（随机分配的）对应的<code>RAM[i]</code>命名为<code>sym</code>。</p>
<p>以下有一个内置变量的表格：包括 16 个虚拟内存器，2 个用于 IO 设备，6
个用于虚拟机和编译器。</p>
<table>
<thead>
<tr>
<th>symbol</th>
<th>value</th>
</tr>
</thead>
<tbody>
<tr>
<td>R0</td>
<td>0</td>
</tr>
<tr>
<td>R1</td>
<td>1</td>
</tr>
<tr>
<td>R2</td>
<td>2</td>
</tr>
<tr>
<td>...</td>
<td>...</td>
</tr>
<tr>
<td>R15</td>
<td>15</td>
</tr>
<tr>
<td>SCREEN</td>
<td>16384</td>
</tr>
<tr>
<td>KBD</td>
<td>24576</td>
</tr>
<tr>
<td>SP</td>
<td>0</td>
</tr>
<tr>
<td>LCL</td>
<td>1</td>
</tr>
<tr>
<td>ARG</td>
<td>2</td>
</tr>
<tr>
<td>THIS</td>
<td>3</td>
</tr>
<tr>
<td>THAT</td>
<td>4</td>
</tr>
</tbody>
</table>
<p>标签：为一段代码定义一个标签，可以执行跳转功能，负责实现 if - else 和
循环语句。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410172239078.webp"></p>
<p>其中<code>(label)</code>主要是标记跳转的地方的开始，<code>@label</code>表示的是执行跳转，如果满足条件。</p>
<p>指针：指针是指向变量的地址。这里使用数组为例，格式如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410172312131.webp"></p>
<p>可以发现：是通过<code>A=...</code>实现的，因为<code>M=RAM[A]</code>，利用这个特性，可以实现指针访问数组。</p>
<p>另外一个案例：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410172313979.webp"></p>
<p><strong>建议</strong>：</p>
<ol type="1">
<li><p>最好以以下格式为结尾，防止发生<code>NOP</code>。</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">@value</span><br><span class="line">0;JMP</span><br></pre></td></tr></tbody></table></figure>
<p>有一个对应上面的例子：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410172241392.webp"></p></li>
<li><p>为了提高可读性，使用代码 2 代替代码 1：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="code"><pre><span class="line">// Code 1</span><br><span class="line">//RAM[5]=15</span><br><span class="line">@15</span><br><span class="line">D=A</span><br><span class="line"></span><br><span class="line">@5</span><br><span class="line">M=D</span><br><span class="line"></span><br><span class="line">// Code 2</span><br><span class="line">//RAM[5]=15</span><br><span class="line">@15</span><br><span class="line">D=A</span><br><span class="line"></span><br><span class="line">@R5</span><br><span class="line">M=D</span><br></pre></td></tr></tbody></table></figure></li>
</ol>
<p>​</p>
<h2 id="step-5-hack-computer">Step 5 Hack Computer</h2>
<h3 id="memory">Memory</h3>
<p>以下是电路图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410181508818.webp"></p>
<p>实现原理和前面的 RAM
同理，主要是注意需要使用<code>Screen</code>和<code>KeyBoard</code></p>
<p>这里使用 Mux4Way16，可以划分为四路，前两路对应的是
RAM16K，后两路对应的分别是 Screen 和 Keyboard。</p>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">5</span>/Memory.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The complete address space of the Hack computer's memory,</span></span><br><span class="line"><span class="comment"> * including RAM and memory-mapped I/O.</span></span><br><span class="line"><span class="comment"> * The chip facilitates read and write operations, as follows:</span></span><br><span class="line"><span class="comment"> *     Read:  out(t) = Memory[address(t)](t)</span></span><br><span class="line"><span class="comment"> *     Write: if load(t-1) then Memory[address(t-1)](t) = in(t-1)</span></span><br><span class="line"><span class="comment"> * In words: the chip always outputs the value stored at the memory</span></span><br><span class="line"><span class="comment"> * location specified by address. If load=1, the in value is loaded</span></span><br><span class="line"><span class="comment"> * into the memory location specified by address. This value becomes</span></span><br><span class="line"><span class="comment"> * available through the out output from the next time step onward.</span></span><br><span class="line"><span class="comment"> * Address space rules:</span></span><br><span class="line"><span class="comment"> * Only the upper 16K+8K+1 words of the Memory chip are used.</span></span><br><span class="line"><span class="comment"> * Access to address&gt;0x6000 is invalid and reads 0. Access to any address</span></span><br><span class="line"><span class="comment"> * in the range 0x4000-0x5FFF results in accessing the screen memory</span></span><br><span class="line"><span class="comment"> * map. Access to address 0x6000 results in accessing the keyboard</span></span><br><span class="line"><span class="comment"> * memory map. The behavior in these addresses is described in the Screen</span></span><br><span class="line"><span class="comment"> * and Keyboard chip specifications given in the lectures and the book.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Memory {</span><br><span class="line">    <span class="keyword">IN</span> <span class="keyword">in</span>[<span class="number">16</span>], load, address[<span class="number">15</span>];</span><br><span class="line">    <span class="keyword">OUT</span> <span class="keyword">out</span>[<span class="number">16</span>];</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">	//// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    DMux4Way(<span class="keyword">in</span>= load, sel= address[<span class="number">13</span>..<span class="number">14</span>], a= temp0, b= temp1, c= load1, d= load2);</span><br><span class="line">    <span class="keyword">Or</span>(a= temp0, b= temp1, <span class="keyword">out</span>= load0);</span><br><span class="line">    RAM16K(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load0, address= address[<span class="number">0</span>..<span class="number">13</span>], <span class="keyword">out</span>= o1);</span><br><span class="line">    Keyboard(<span class="keyword">out</span>= o3);</span><br><span class="line">    Screen(<span class="keyword">in</span>= <span class="keyword">in</span>, load= load1, address= address[<span class="number">0</span>..<span class="number">12</span>], <span class="keyword">out</span>= o2);</span><br><span class="line">    Mux4Way16(a= o1, b= o1, c= o2, d= o3, sel= address[<span class="number">13</span>..<span class="number">14</span>], <span class="keyword">out</span>= <span class="keyword">out</span>);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="computer">Computer</h3>
<p>以下是电路实现图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410181509678.webp"></p>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">5</span>/Computer.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Hack computer, consisting of CPU, ROM and RAM.</span></span><br><span class="line"><span class="comment"> * When reset = 0, the program stored in the ROM executes.</span></span><br><span class="line"><span class="comment"> * When reset = 1, the program's execution restarts.</span></span><br><span class="line"><span class="comment"> * Thus, to start running the currently loaded program,</span></span><br><span class="line"><span class="comment"> * set reset to 1, and then set it to 0.</span></span><br><span class="line"><span class="comment"> * From this point onwards, the user is at the mercy of the software.</span></span><br><span class="line"><span class="comment"> * Depending on the program's code, and whether the code is correct,</span></span><br><span class="line"><span class="comment"> * the screen may show some output, the user may be expected to enter</span></span><br><span class="line"><span class="comment"> * some input using the keyboard, or the program may do some procerssing.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP Computer {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">IN</span> reset;</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">    //// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line">    ROM32K(address= <span class="keyword">next</span>, <span class="keyword">out</span>= ins);</span><br><span class="line">    CPU(inM= num, instruction= ins, reset= reset, outM= oM, writeM= wM, addressM= aM, pc= <span class="keyword">next</span>);</span><br><span class="line">    Memory(<span class="keyword">in</span>= oM, load= wM, address= aM, <span class="keyword">out</span>= num);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="cpu">CPU</h3>
<p>最复杂的部分，需要对每个状态位的功能进行分析。</p>
<figure class="highlight vhdl"><table><tbody><tr><td class="code"><pre><span class="line">// This <span class="keyword">file</span> <span class="keyword">is</span> part <span class="keyword">of</span> www.nand2tetris.org</span><br><span class="line">// <span class="keyword">and</span> the book <span class="string">"The Elements of Computing Systems"</span></span><br><span class="line">// by Nisan <span class="keyword">and</span> Schocken, MIT Press.</span><br><span class="line">// <span class="keyword">File</span> name: projects/<span class="number">5</span>/CPU.hdl</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * The Hack Central Processing unit (CPU).</span></span><br><span class="line"><span class="comment"> * Parses the binary code in the instruction input and executes it according to the</span></span><br><span class="line"><span class="comment"> * Hack machine language specification. In the case of a C-instruction, computes the</span></span><br><span class="line"><span class="comment"> * function specified by the instruction. If the instruction specifies to read a memory</span></span><br><span class="line"><span class="comment"> * value, the inM input is expected to contain this value. If the instruction specifies</span></span><br><span class="line"><span class="comment"> * to write a value to the memory, sets the outM output to this value, sets the addressM</span></span><br><span class="line"><span class="comment"> * output to the target address, and asserts the writeM output (when writeM = 0, any</span></span><br><span class="line"><span class="comment"> * value may appear in outM).</span></span><br><span class="line"><span class="comment"> * If the reset input is 0, computes the address of the next instruction and sets the</span></span><br><span class="line"><span class="comment"> * pc output to that value. If the reset input is 1, sets pc to 0.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">Note:</span> The outM and writeM outputs are combinational: they are affected by the</span></span><br><span class="line"><span class="comment"> * instruction's execution during the current cycle. The addressM and pc outputs are</span></span><br><span class="line"><span class="comment"> * clocked: although they are affected by the instruction's execution, they commit to</span></span><br><span class="line"><span class="comment"> * their new values only in the next cycle.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">CHIP CPU {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">IN</span>  inM[<span class="number">16</span>],         // M value input  (M = contents <span class="keyword">of</span> RAM[A])</span><br><span class="line">        instruction[<span class="number">16</span>], // Instruction <span class="keyword">for</span> execution</span><br><span class="line">        reset;           // Signals whether <span class="keyword">to</span> re-start the current</span><br><span class="line">                         // program (reset==<span class="number">1</span>) <span class="keyword">or</span> continue executing</span><br><span class="line">                         // the current program (reset==<span class="number">0</span>).</span><br><span class="line"></span><br><span class="line">    <span class="keyword">OUT</span> outM[<span class="number">16</span>],        // M value output</span><br><span class="line">        writeM,          // Write <span class="keyword">to</span> M?</span><br><span class="line">        addressM[<span class="number">15</span>],    // Address <span class="keyword">in</span> data memory (<span class="keyword">of</span> M)</span><br><span class="line">        pc[<span class="number">15</span>];          // address <span class="keyword">of</span> <span class="keyword">next</span> instruction</span><br><span class="line"></span><br><span class="line">    PARTS:</span><br><span class="line">	//// Replace this comment <span class="keyword">with</span> your code.</span><br><span class="line"></span><br><span class="line">    //first Mux16</span><br><span class="line">    //c=<span class="number">0</span> instruction</span><br><span class="line">    //c=<span class="number">1</span> ALUout</span><br><span class="line">    Mux16(a= instruction, b= ALUout, sel= instruction[<span class="number">15</span>], <span class="keyword">out</span>= Mout1);</span><br><span class="line"></span><br><span class="line">    //because <span class="keyword">when</span> c=<span class="number">0</span>, A-instruction will set A <span class="keyword">register</span> <span class="keyword">to</span> xxx</span><br><span class="line">    //so <span class="keyword">when</span> c=<span class="number">0</span>, we need <span class="keyword">to</span> set load(A) <span class="keyword">is</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span>= instruction[<span class="number">15</span>], <span class="keyword">out</span>= notOp);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">when</span> c=<span class="number">1</span>, we need <span class="keyword">to</span> focus <span class="keyword">on</span> ins[<span class="number">5</span>].., so we will get ins[<span class="number">5</span>]..</span><br><span class="line">    <span class="keyword">Or</span>(a= instruction[<span class="number">5</span>], b= notOp, <span class="keyword">out</span>= load0);</span><br><span class="line"></span><br><span class="line">    //A <span class="keyword">register</span></span><br><span class="line">    <span class="keyword">Register</span>(<span class="keyword">in</span>= Mout1, load= load0, <span class="keyword">out</span>= Aout, <span class="keyword">out</span>[<span class="number">0</span>..<span class="number">14</span>]= addressM);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">for</span> C-instruction many-bits need calculate</span><br><span class="line">    //<span class="keyword">for</span> second Mux16</span><br><span class="line">    <span class="keyword">And</span>(a= instruction[<span class="number">15</span>], b= instruction[<span class="number">12</span>], <span class="keyword">out</span>= load1);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">for</span> D <span class="keyword">register</span></span><br><span class="line">    <span class="keyword">And</span>(a= instruction[<span class="number">15</span>], b= instruction[<span class="number">4</span>], <span class="keyword">out</span>= load2);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">for</span> writeM</span><br><span class="line">    <span class="keyword">And</span>(a= instruction[<span class="number">15</span>], b= instruction[<span class="number">3</span>], <span class="keyword">out</span>= writeM);</span><br><span class="line"></span><br><span class="line">    //D <span class="keyword">register</span></span><br><span class="line">    <span class="keyword">Register</span>(<span class="keyword">in</span>= ALUout, load= load2, <span class="keyword">out</span>= Dout);</span><br><span class="line"></span><br><span class="line">    //Second Mux16</span><br><span class="line">    Mux16(a= Aout, b= inM, sel= load1, <span class="keyword">out</span>= Mout2);</span><br><span class="line"></span><br><span class="line">    //ALU</span><br><span class="line">    //because <span class="keyword">when</span> c=<span class="number">0</span> load2=<span class="number">0</span>,D <span class="keyword">register</span> makes no change</span><br><span class="line">    //so we don<span class="symbol">'t</span> need <span class="keyword">to</span> test c=<span class="number">0</span> <span class="keyword">or</span> c=<span class="number">1</span> <span class="keyword">then</span> test ins[<span class="number">11</span>..<span class="number">6</span>]</span><br><span class="line">    ALU(x= Dout, y= Mout2, zx= instruction[<span class="number">11</span>], nx= instruction[<span class="number">10</span>], zy= instruction[<span class="number">9</span>], ny= instruction[<span class="number">8</span>], f= instruction[<span class="number">7</span>], no= instruction[<span class="number">6</span>], <span class="keyword">out</span>= outM, <span class="keyword">out</span>= ALUout, zr= Azero, ng= Ang);</span><br><span class="line"></span><br><span class="line">    //PC</span><br><span class="line">    <span class="keyword">Or</span>(a= Azero, b= Ang, <span class="keyword">out</span>= sym);</span><br><span class="line">    <span class="keyword">Not</span>(<span class="keyword">in</span>= sym, <span class="keyword">out</span>= <span class="built_in">Positive</span>);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">out</span> &gt; <span class="number">0</span> can JMP</span><br><span class="line">    <span class="keyword">And</span>(a= <span class="built_in">Positive</span>, b= instruction[<span class="number">0</span>], <span class="keyword">out</span>= isPositive);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">out</span> == <span class="number">0</span> can JMP</span><br><span class="line">    <span class="keyword">And</span>(a= Azero, b= instruction[<span class="number">1</span>], <span class="keyword">out</span>= isZero);</span><br><span class="line"></span><br><span class="line">    //<span class="keyword">out</span> &lt; <span class="number">0</span> can JMP</span><br><span class="line">    <span class="keyword">And</span>(a= Ang, b= instruction[<span class="number">2</span>], <span class="keyword">out</span>= lessZero);</span><br><span class="line"></span><br><span class="line">    //no condition can JMP</span><br><span class="line">    <span class="keyword">And</span>(a= instruction[<span class="number">2</span>], b=instruction[<span class="number">1</span>], <span class="keyword">out</span>= t12);</span><br><span class="line">    <span class="keyword">And</span>(a= instruction[<span class="number">0</span>], b=t12, <span class="keyword">out</span>= temp);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">Or</span>(a= isPositive, b= isZero, <span class="keyword">out</span>= temp1);</span><br><span class="line">    <span class="keyword">Or</span>(a= temp1, b= lessZero, <span class="keyword">out</span>= temp2);</span><br><span class="line">    <span class="keyword">Or</span>(a= temp2, b= temp, <span class="keyword">out</span>= temp3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">And</span>(a= temp3, b= instruction[<span class="number">15</span>], <span class="keyword">out</span>= condition);</span><br><span class="line">    PC(<span class="keyword">in</span>= Aout, load= condition, inc= <span class="literal">true</span>, reset= reset, <span class="keyword">out</span>[<span class="number">0</span>..<span class="number">14</span>]=pc);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-6-assembler">Step 6 Assembler</h2>
<p>按照书上的 API，编写的各个类结构如下：</p>
<h3 id="code-类">Code 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line">|         Code           |</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line">| - destLib: map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;  |</span><br><span class="line">| - compLib: map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;  |</span><br><span class="line">| - jumpLib: map&lt;<span class="built_in">string</span>, <span class="built_in">string</span>&gt;  |</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line">| + Code()                           |</span><br><span class="line">| + ~Code()                         |</span><br><span class="line">| + dest(para_string: <span class="built_in">string</span>): <span class="built_in">string</span>|</span><br><span class="line">| + comp(para_string: <span class="built_in">string</span>): <span class="built_in">string</span>|</span><br><span class="line">| + jump(para_string: <span class="built_in">string</span>): <span class="built_in">string</span>|</span><br><span class="line">+<span class="comment">-----------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CODE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CODE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Code</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">Code</span>();</span><br><span class="line">    ~<span class="built_in">Code</span>();</span><br><span class="line">    <span class="function">std::string <span class="title">dest</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span></span>;	<span class="comment">//返回dest助记符的二进制码</span></span><br><span class="line">    <span class="function">std::string <span class="title">comp</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span></span>;	<span class="comment">//返回comp助记符的二进制码</span></span><br><span class="line">    <span class="function">std::string <span class="title">jump</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span></span>;	<span class="comment">//返回jump助记符的二进制码</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="comment">//三个对应的map，用于存储助记符对应的二进制码</span></span><br><span class="line">    std::map&lt;std::string, std::string&gt; destLib, compLib, jumpLib;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//CODE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Code.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread_compat.h&gt;</span></span></span><br><span class="line"></span><br><span class="line">Code::<span class="built_in">Code</span>() {</span><br><span class="line">    <span class="comment">//init destLib</span></span><br><span class="line">    destLib[<span class="string">"null"</span>] = <span class="string">"000"</span>;</span><br><span class="line">    destLib[<span class="string">"M"</span>] = <span class="string">"001"</span>;</span><br><span class="line">    destLib[<span class="string">"D"</span>] = <span class="string">"010"</span>;</span><br><span class="line">    destLib[<span class="string">"MD"</span>] = <span class="string">"011"</span>;</span><br><span class="line">    destLib[<span class="string">"A"</span>] = <span class="string">"100"</span>;</span><br><span class="line">    destLib[<span class="string">"AM"</span>] = <span class="string">"101"</span>;</span><br><span class="line">    destLib[<span class="string">"AD"</span>] = <span class="string">"110"</span>;</span><br><span class="line">    destLib[<span class="string">"AMD"</span>] = <span class="string">"111"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//init comp</span></span><br><span class="line">    compLib[<span class="string">"0"</span>] = <span class="string">"0101010"</span>;</span><br><span class="line">    compLib[<span class="string">"1"</span>] = <span class="string">"0111111"</span>;</span><br><span class="line">    compLib[<span class="string">"-1"</span>] = <span class="string">"0111010"</span>;</span><br><span class="line">    compLib[<span class="string">"D"</span>] = <span class="string">"0001100"</span>;</span><br><span class="line">    compLib[<span class="string">"A"</span>] = <span class="string">"0110000"</span>;</span><br><span class="line">    compLib[<span class="string">"M"</span>] = <span class="string">"1110000"</span>;</span><br><span class="line">    compLib[<span class="string">"!D"</span>] = <span class="string">"0001101"</span>;</span><br><span class="line">    compLib[<span class="string">"!A"</span>] = <span class="string">"0110001"</span>;</span><br><span class="line">    compLib[<span class="string">"!M"</span>] = <span class="string">"1110001"</span>;</span><br><span class="line">    compLib[<span class="string">"-D"</span>] = <span class="string">"0001111"</span>;</span><br><span class="line">    compLib[<span class="string">"-A"</span>] = <span class="string">"0110011"</span>;</span><br><span class="line">    compLib[<span class="string">"-M"</span>] = <span class="string">"1110011"</span>;</span><br><span class="line">    compLib[<span class="string">"D+1"</span>] = <span class="string">"0011111"</span>;</span><br><span class="line">    compLib[<span class="string">"A+1"</span>] = <span class="string">"0110111"</span>;</span><br><span class="line">    compLib[<span class="string">"M+1"</span>] = <span class="string">"1110111"</span>;</span><br><span class="line">    compLib[<span class="string">"D-1"</span>] = <span class="string">"0001110"</span>;</span><br><span class="line">    compLib[<span class="string">"A-1"</span>] = <span class="string">"0110010"</span>;</span><br><span class="line">    compLib[<span class="string">"M-1"</span>] = <span class="string">"1110010"</span>;</span><br><span class="line">    compLib[<span class="string">"D+A"</span>] = <span class="string">"0000010"</span>;</span><br><span class="line">    compLib[<span class="string">"D+M"</span>] = <span class="string">"1000010"</span>;</span><br><span class="line">    compLib[<span class="string">"D-A"</span>] = <span class="string">"0010011"</span>;</span><br><span class="line">    compLib[<span class="string">"D-M"</span>] = <span class="string">"1010011"</span>;</span><br><span class="line">    compLib[<span class="string">"A-D"</span>] = <span class="string">"0000111"</span>;</span><br><span class="line">    compLib[<span class="string">"M-D"</span>] = <span class="string">"1000111"</span>;</span><br><span class="line">    compLib[<span class="string">"D&amp;A"</span>] = <span class="string">"0000000"</span>;</span><br><span class="line">    compLib[<span class="string">"D&amp;M"</span>] = <span class="string">"1000000"</span>;</span><br><span class="line">    compLib[<span class="string">"D|A"</span>] = <span class="string">"0010101"</span>;</span><br><span class="line">    compLib[<span class="string">"D|M"</span>] = <span class="string">"1010101"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//init jump</span></span><br><span class="line">    jumpLib[<span class="string">"null"</span>] = <span class="string">"000"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JGT"</span>] = <span class="string">"001"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JEQ"</span>] = <span class="string">"010"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JGE"</span>] = <span class="string">"011"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JLT"</span>] = <span class="string">"100"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JNE"</span>] = <span class="string">"101"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JLE"</span>] = <span class="string">"110"</span>;</span><br><span class="line">    jumpLib[<span class="string">"JMP"</span>] = <span class="string">"111"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">Code::~<span class="built_in">Code</span>() = <span class="keyword">default</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Code::dest</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> destLib[para_string];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Code::comp</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> compLib[para_string];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Code::jump</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> jumpLib[para_string];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="symboltable-类">SymbolTable 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">|       SymbolTable           |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| - tot: int = <span class="number">23</span>             |</span><br><span class="line">| - symbolLib: map&lt;<span class="built_in">string</span>, int&gt;|</span><br><span class="line">| - usedValues: set&lt;int&gt;      |</span><br><span class="line">| - start: int = <span class="number">16</span>           |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| + constructor()             |</span><br><span class="line">| + addEntry(para_string: <span class="built_in">string</span>, address: int) |</span><br><span class="line">| + contains(para_string: <span class="built_in">string</span>): bool         |</span><br><span class="line">| + getAddress(para_string: <span class="built_in">string</span>): int        |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> SYMBOLTABLE_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYMBOLTABLE_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;set&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SymbolTable</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">constructor</span><span class="params">()</span></span>;                                                     <span class="comment">//制订空的符号表</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">addEntry</span><span class="params">(<span class="type">const</span> std::string &amp;para_string, <span class="type">const</span> <span class="type">int</span> &amp;address)</span></span>;      <span class="comment">//将(symbol, address)配对加入到符号表中</span></span><br><span class="line">    [[nodiscard]] <span class="function"><span class="type">bool</span> <span class="title">contains</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> <span class="type">const</span></span>;      <span class="comment">//符号表中是否包含了指定的symbol</span></span><br><span class="line">    <span class="function"><span class="type">int</span> <span class="title">getAddress</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span></span>;                         <span class="comment">//返回与symbol相关的地址</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="type">int</span> tot = <span class="number">23</span>;                               <span class="comment">//记录总共的symbol数目</span></span><br><span class="line">    std::map&lt;std::string, <span class="type">int</span>&gt; symbolLib;       <span class="comment">//存储符号表</span></span><br><span class="line">    std::set&lt;<span class="type">int</span>&gt; usedValues;                   <span class="comment">//记录已经使用过的地址</span></span><br><span class="line">    <span class="type">int</span> start = <span class="number">16</span>;                             <span class="comment">//记录最后一个使用过的地址，按照从小到大的顺序</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//SYMBOLTABLE_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"SymbolTable.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;set&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SymbolTable::constructor</span><span class="params">()</span> </span>{</span><br><span class="line">    symbolLib[<span class="string">"SP"</span>] = <span class="number">0</span>;</span><br><span class="line">    symbolLib[<span class="string">"LCL"</span>] = <span class="number">1</span>;</span><br><span class="line">    symbolLib[<span class="string">"ARG"</span>] = <span class="number">2</span>;</span><br><span class="line">    symbolLib[<span class="string">"THIS"</span>] = <span class="number">3</span>;</span><br><span class="line">    symbolLib[<span class="string">"THAT"</span>] = <span class="number">4</span>;</span><br><span class="line">    symbolLib[<span class="string">"SCREEN"</span>] = <span class="number">16384</span>;</span><br><span class="line">    symbolLib[<span class="string">"KBD"</span>] = <span class="number">24576</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">16</span>; ++i) {</span><br><span class="line">        std::string num = std::<span class="built_in">to_string</span>(i);</span><br><span class="line">        std::string str = <span class="string">"R"</span> + num;</span><br><span class="line">        symbolLib[str] = i;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储已经使用过的address</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">auto</span> &amp;[str, value]: symbolLib) {</span><br><span class="line">        usedValues.<span class="built_in">insert</span>(value);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">SymbolTable::contains</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="keyword">return</span> symbolLib.<span class="built_in">count</span>(para_string);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SymbolTable::addEntry</span><span class="params">(<span class="type">const</span> std::string &amp;para_string, <span class="type">const</span> <span class="type">int</span> &amp;address)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(address != <span class="number">-1</span>) {</span><br><span class="line">        symbolLib[para_string] = address;</span><br><span class="line">        tot++;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">while</span> (usedValues.<span class="built_in">count</span>(start)) {</span><br><span class="line">            start++;</span><br><span class="line">        }</span><br><span class="line">        symbolLib[para_string] = start;</span><br><span class="line">        usedValues.<span class="built_in">insert</span>(start);</span><br><span class="line">        tot++;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">SymbolTable::getAddress</span><span class="params">(<span class="type">const</span> std::string &amp;para_string)</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> symbolLib[para_string];</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="praser-类">Praser 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------------------------------+</span></span><br><span class="line">|             Praser               |</span><br><span class="line">+<span class="comment">----------------------------------+</span></span><br><span class="line">| + inputs: vector&lt;<span class="built_in">string</span>&gt;         |</span><br><span class="line">| + current_command: <span class="built_in">string</span>        |</span><br><span class="line">| + current_id: int = <span class="number">-1</span>           |</span><br><span class="line">| + count: int = <span class="number">0</span>                 |</span><br><span class="line">+<span class="comment">----------------------------------+</span></span><br><span class="line">| + init(file_name: <span class="built_in">string</span>): void  |</span><br><span class="line">| + hasMoreCommands(): bool        |</span><br><span class="line">| + advance(): void                |</span><br><span class="line">| + commandType(): <span class="built_in">char</span>            |</span><br><span class="line">| + symbol(): <span class="built_in">string</span>               |</span><br><span class="line">| + dest(): <span class="built_in">string</span>                 |</span><br><span class="line">| + comp(): <span class="built_in">string</span>                 |</span><br><span class="line">| + jump(): <span class="built_in">string</span>                 |</span><br><span class="line">| + reset(): void                  |</span><br><span class="line">+<span class="comment">----------------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRASER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRASER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;queue&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Praser</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> std::string &amp;file_name)</span></span>;        <span class="comment">//对文件进行初步读取：删去空行，空格，注释，打开文件输入流，为语法解析做准备</span></span><br><span class="line">    [[nodiscard]]<span class="function"><span class="type">bool</span> <span class="title">hasMoreCommands</span><span class="params">()</span> <span class="type">const</span></span>;      <span class="comment">//确认输入中是否还有更多命令</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">advance</span><span class="params">()</span></span>;                                 <span class="comment">//从输入中读取下一条指令，将其当作“当前指令”，当且仅当hasMoreCommandS()为真时</span></span><br><span class="line">    [[nodiscard]]<span class="function"><span class="type">char</span> <span class="title">commandType</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">//返回指令类型：A:@  L: ()  C: dest=comp;jump</span></span><br><span class="line">    [[nodiscard]]<span class="function">std::string <span class="title">symbol</span><span class="params">()</span> <span class="type">const</span></span>;        <span class="comment">//返回指令为A或L类型时，当前命令的符号和十进制值</span></span><br><span class="line">    [[nodiscard]]<span class="function">std::string <span class="title">dest</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">//返回当前C指令的dest助记符</span></span><br><span class="line">    [[nodiscard]]<span class="function">std::string <span class="title">comp</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">//返回当前C指令的comp助记符</span></span><br><span class="line">    [[nodiscard]]<span class="function">std::string <span class="title">jump</span><span class="params">()</span> <span class="type">const</span></span>;          <span class="comment">//返回当前C指令的jump助记符</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;                                   <span class="comment">//重置</span></span><br><span class="line">    std::vector&lt;std::string&gt; inputs;                <span class="comment">//用来存储输入的指令</span></span><br><span class="line">    std::string current_command;                    <span class="comment">//当前正在处理的指令</span></span><br><span class="line">    <span class="type">int</span> current_id = <span class="number">-1</span>;                            <span class="comment">//当前指令的id</span></span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;                                  <span class="comment">//记录总共有多少条指令</span></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//PRASER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-19.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Praser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;algorithm&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Praser::init</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> </span>{</span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="comment">//判断是否能够打开文件</span></span><br><span class="line">    <span class="keyword">if</span>(!file.<span class="built_in">is_open</span>()) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! can not open the file"</span>;</span><br><span class="line">    }</span><br><span class="line">    std::string line;</span><br><span class="line">    <span class="comment">//使用getline进行逐行读取指令</span></span><br><span class="line">    <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file, line)) {</span><br><span class="line">        <span class="keyword">if</span>(line.<span class="built_in">empty</span>()) {  <span class="comment">//空指令，删去</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        std::string new_line;       <span class="comment">//删去指令中的空格符号</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> ch: line) {</span><br><span class="line">            <span class="keyword">if</span>(ch != <span class="string">' '</span>) {</span><br><span class="line">                new_line += ch;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="type">size_t</span> pos = new_line.<span class="built_in">find</span>(<span class="string">"//"</span>);       <span class="comment">//删去指令中的注释，保留该行中注释前面的内容</span></span><br><span class="line">        <span class="keyword">if</span>(pos == std::string::npos) {</span><br><span class="line">            std::string str = new_line.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">            new_line = str;</span><br><span class="line">            inputs.<span class="built_in">emplace_back</span>(new_line);</span><br><span class="line">            count++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Praser::hasMoreCommands</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="keyword">return</span> current_id &lt; count - <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Praser::advance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">hasMoreCommands</span>())   current_command = inputs[++current_id];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">char</span> <span class="title">Praser::commandType</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(current_command[<span class="number">0</span>] == <span class="string">'@'</span>)   <span class="keyword">return</span> <span class="string">'A'</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(current_command[<span class="number">0</span>] == <span class="string">'('</span>)  <span class="keyword">return</span> <span class="string">'L'</span>;</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">'C'</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::symbol</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="keyword">if</span>(current_command[<span class="number">0</span>] == <span class="string">'@'</span>) {         <span class="comment">//读取A指令对应的符号</span></span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(<span class="number">1</span>, current_command.<span class="built_in">size</span>() - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {          <span class="comment">//读取L指令对应的符号</span></span><br><span class="line">        <span class="type">size_t</span> pos_next = current_command.<span class="built_in">find</span>(<span class="string">')'</span>);</span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(<span class="number">1</span>, pos_next - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::dest</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="type">size_t</span> pos = current_command.<span class="built_in">find</span>(<span class="string">'='</span>);</span><br><span class="line">    <span class="keyword">if</span>(pos == std::string::npos) {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"null"</span>;</span><br><span class="line">    }</span><br><span class="line">    std::string str = current_command.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="keyword">return</span> str;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::comp</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="comment">//对应三种情况：</span></span><br><span class="line">    <span class="comment">//dest jump都有</span></span><br><span class="line">    <span class="comment">//dest jump其中之一有</span></span><br><span class="line">    <span class="comment">//两者都无</span></span><br><span class="line">    <span class="type">size_t</span> pos_eq = current_command.<span class="built_in">find</span>(<span class="string">'='</span>);</span><br><span class="line">    <span class="type">size_t</span> pos_sc = current_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">    <span class="keyword">if</span>(pos_eq != std::string::npos &amp;&amp; pos_sc != std::string::npos) {</span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(pos_eq + <span class="number">1</span>, pos_sc - pos_eq - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pos_eq != std::string::npos &amp;&amp; pos_sc == std::string::npos) {</span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(pos_eq + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pos_eq == std::string::npos &amp;&amp; pos_sc != std::string::npos) {</span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(<span class="number">0</span>, pos_sc);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> current_command;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::jump</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="type">size_t</span> pos_sc = current_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">    <span class="keyword">if</span>(pos_sc != std::string::npos) {</span><br><span class="line">        std::string str = current_command.<span class="built_in">substr</span>(pos_sc + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"null"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Praser::reset</span><span class="params">()</span> </span>{</span><br><span class="line">    current_command = <span class="string">""</span>;</span><br><span class="line">    current_id = <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="test-类">test 类</h3>
<p>自己编写的测试类</p>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">|                 test                   |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">| - binaryfile: vector&lt;<span class="built_in">string</span>&gt;           |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br><span class="line">| + init(filename: <span class="built_in">string</span>): void         |</span><br><span class="line">| + findDifference(compare_file: vector&lt;<span class="built_in">string</span>&gt;): void |</span><br><span class="line">+<span class="comment">----------------------------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-20.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> TEST_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TEST_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">test</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span></span>;                                     <span class="comment">//初始化，读取hack文件</span></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">findDifference</span><span class="params">(<span class="type">const</span> std::vector&lt;std::string&gt; &amp;compare_file)</span> <span class="type">const</span></span>;    <span class="comment">//进行文件的比较</span></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::vector&lt;std::string&gt; binaryfile;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//TEST_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-20.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"test.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test::init</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> </span>{</span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(!file.<span class="built_in">is_open</span>()) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! can not open the file"</span>;</span><br><span class="line">    }</span><br><span class="line">    std::string line;</span><br><span class="line">    <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file, line)) {</span><br><span class="line">        binaryfile.<span class="built_in">emplace_back</span>(line);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test::findDifference</span><span class="params">(<span class="type">const</span> std::vector&lt;std::string&gt; &amp;compare_file)</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="type">bool</span> ok = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; binaryfile.<span class="built_in">size</span>(); ++i) {</span><br><span class="line">        <span class="keyword">if</span>(binaryfile[i] != compare_file[i]) {</span><br><span class="line">            ok = <span class="literal">false</span>;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">"error! string "</span> &lt;&lt; i &lt;&lt; <span class="string">" is different\n"</span>;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">"binary["</span> &lt;&lt; i &lt;&lt; <span class="string">"] is "</span> &lt;&lt; binaryfile[i] &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">"compare_file["</span> &lt;&lt; i &lt;&lt; <span class="string">"] is "</span> &lt;&lt; compare_file[i] &lt;&lt; <span class="string">"\n"</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(ok)  std::cout &lt;&lt; <span class="string">"success!\n"</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="main">main</h3>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;bits/stdc++.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Code.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Praser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"SymbolTable.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"test.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>{</span><br><span class="line">    Praser praser;</span><br><span class="line">    Code code;</span><br><span class="line">    SymbolTable symbol_table;</span><br><span class="line"></span><br><span class="line">    test machine;</span><br><span class="line"></span><br><span class="line">    std::cout &lt;&lt; <span class="string">"binary file\n"</span>;</span><br><span class="line">    std::string fileName = <span class="string">"../AllTest/Add.asm"</span>;</span><br><span class="line">    std::string checkName = <span class="string">"../AllTest/Add.hack"</span>;</span><br><span class="line">    machine.<span class="built_in">init</span>(checkName);</span><br><span class="line"></span><br><span class="line">    praser.<span class="built_in">init</span>(fileName);</span><br><span class="line">    symbol_table.<span class="built_in">constructor</span>();</span><br><span class="line">    std::vector&lt;std::string&gt; tempfile;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;      <span class="comment">//关键变量：用于记录当前扫描到第几行</span></span><br><span class="line">    <span class="comment">// 构建符号表：先扫描L指令：添加到symbol_table中，并忽略，其余指令正常添加到处理文件中</span></span><br><span class="line">    <span class="keyword">while</span>(praser.<span class="built_in">hasMoreCommands</span>()) {</span><br><span class="line">        praser.<span class="built_in">advance</span>();</span><br><span class="line">        <span class="type">char</span> commandType = praser.<span class="built_in">commandType</span>();</span><br><span class="line">        <span class="keyword">if</span>(commandType == <span class="string">'L'</span>) {</span><br><span class="line">            std::string new_symbol = praser.<span class="built_in">symbol</span>();</span><br><span class="line">            <span class="keyword">if</span>(symbol_table.<span class="built_in">contains</span>(new_symbol) == <span class="literal">false</span>) {</span><br><span class="line">                symbol_table.<span class="built_in">addEntry</span>(new_symbol, count);</span><br><span class="line">                std::string str = praser.current_command;</span><br><span class="line">                <span class="type">size_t</span> pos = str.<span class="built_in">find</span>(<span class="string">')'</span>);</span><br><span class="line">                std::string left = str.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span>(left.<span class="built_in">empty</span>() == <span class="literal">false</span>) {     <span class="comment">//判断L指令后面是否还有其他的指令：如A指令，C指令</span></span><br><span class="line">                    tempfile.<span class="built_in">emplace_back</span>(left);</span><br><span class="line">                    count++;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            std::string str = praser.current_command;</span><br><span class="line">            tempfile.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">            count++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    praser.<span class="built_in">reset</span>();</span><br><span class="line">    praser.inputs = tempfile;</span><br><span class="line">    std::vector&lt;std::string&gt; binaryfile;</span><br><span class="line">    std::string temp_varible;</span><br><span class="line">    <span class="type">bool</span> ok = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span>(praser.<span class="built_in">hasMoreCommands</span>()) {           <span class="comment">//对变量进行处理</span></span><br><span class="line">        praser.<span class="built_in">advance</span>();</span><br><span class="line">        <span class="type">char</span> commandType = praser.<span class="built_in">commandType</span>();</span><br><span class="line">        <span class="keyword">if</span>(commandType == <span class="string">'A'</span>) {</span><br><span class="line">            std::string sym = praser.<span class="built_in">symbol</span>();</span><br><span class="line">            <span class="keyword">if</span>(sym[<span class="number">0</span>] &gt;= <span class="string">'0'</span> &amp;&amp; sym[<span class="number">0</span>] &lt;= <span class="string">'9'</span>) {            <span class="comment">//如果是@number类型，直接跳过</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> <span class="keyword">if</span>(symbol_table.<span class="built_in">contains</span>(sym) == <span class="literal">true</span>) {   <span class="comment">//如果在symbol_table找到了，直接修改当前指令</span></span><br><span class="line">                praser.inputs[praser.current_id] = <span class="string">'@'</span> + std::<span class="built_in">to_string</span>(symbol_table.<span class="built_in">getAddress</span>(sym));</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                symbol_table.<span class="built_in">addEntry</span>(sym, <span class="number">-1</span>);     <span class="comment">//否则检查最新的最小可用地址，添加到symbol_table中</span></span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    praser.<span class="built_in">reset</span>();</span><br><span class="line">    <span class="keyword">while</span>(praser.<span class="built_in">hasMoreCommands</span>()) {           <span class="comment">//最终转化为二级制代码</span></span><br><span class="line">        praser.<span class="built_in">advance</span>();</span><br><span class="line">        <span class="type">char</span> commandType = praser.<span class="built_in">commandType</span>();</span><br><span class="line">        <span class="keyword">if</span>(commandType == <span class="string">'A'</span>) {</span><br><span class="line">            std::string str = <span class="string">"0"</span>;</span><br><span class="line">            std::string tmp = praser.current_command.<span class="built_in">substr</span>(<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span>(symbol_table.<span class="built_in">contains</span>(tmp)) {            <span class="comment">//对应符号的情况：先查找地址，再转化为二进制字符串</span></span><br><span class="line">                <span class="type">int</span> address = symbol_table.<span class="built_in">getAddress</span>(tmp);</span><br><span class="line">                std::string binary;</span><br><span class="line">                <span class="keyword">if</span> (address == <span class="number">0</span>)    binary = <span class="string">"000000000000000"</span>;</span><br><span class="line">                <span class="keyword">while</span> (address &gt; <span class="number">0</span>) {</span><br><span class="line">                    binary.<span class="built_in">insert</span>(<span class="number">0</span>, std::<span class="built_in">to_string</span>(address % <span class="number">2</span>));  <span class="comment">// 将二进制位插入到字符串前面</span></span><br><span class="line">                    address /= <span class="number">2</span>;  <span class="comment">// 除以2，继续处理</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">while</span>(binary.<span class="built_in">size</span>() &lt; <span class="number">15</span>) {</span><br><span class="line">                    binary.<span class="built_in">insert</span>(<span class="number">0</span>,std::<span class="built_in">to_string</span>(<span class="number">0</span>));</span><br><span class="line">                }</span><br><span class="line">                str += binary;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {                              <span class="comment">//对应数字的情况：直接转化为二级制字符串</span></span><br><span class="line">                <span class="type">int</span> number = std::<span class="built_in">stoi</span>(tmp);</span><br><span class="line">                std::string binary;</span><br><span class="line">                <span class="keyword">if</span> (number == <span class="number">0</span>)    binary = <span class="string">"000000000000000"</span>;</span><br><span class="line">                <span class="keyword">while</span> (number &gt; <span class="number">0</span>) {</span><br><span class="line">                    binary.<span class="built_in">insert</span>(<span class="number">0</span>, std::<span class="built_in">to_string</span>(number % <span class="number">2</span>));  <span class="comment">// 将二进制位插入到字符串前面</span></span><br><span class="line">                    number /= <span class="number">2</span>;  <span class="comment">// 除以2，继续处理</span></span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">while</span>(binary.<span class="built_in">size</span>() &lt; <span class="number">15</span>) {</span><br><span class="line">                    binary.<span class="built_in">insert</span>(<span class="number">0</span>,std::<span class="built_in">to_string</span>(<span class="number">0</span>));</span><br><span class="line">                }</span><br><span class="line">                str += binary;</span><br><span class="line">            }</span><br><span class="line">            binaryfile.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(commandType == <span class="string">'C'</span>) {           <span class="comment">//对应C指令的情况：先查找符号表，后转化为二进制字符</span></span><br><span class="line">            std::string str = <span class="string">"111"</span>;</span><br><span class="line">            str += code.<span class="built_in">comp</span>(praser.<span class="built_in">comp</span>());</span><br><span class="line">            str += code.<span class="built_in">dest</span>(praser.<span class="built_in">dest</span>());</span><br><span class="line">            str += code.<span class="built_in">jump</span>(praser.<span class="built_in">jump</span>());</span><br><span class="line">            binaryfile.<span class="built_in">emplace_back</span>(str);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// for (auto &amp;str: binaryfile) {</span></span><br><span class="line">    <span class="comment">//     std::cout &lt;&lt; str &lt;&lt; "\n";</span></span><br><span class="line">    <span class="comment">// }</span></span><br><span class="line"></span><br><span class="line">    machine.<span class="built_in">findDifference</span>(binaryfile);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-7-virtual-machine-part1">Step 7 Virtual machine Part1</h2>
<p>按照书上的 API，编写的各个类如下：</p>
<h3 id="praser-类-1">Praser 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">|      Praser          |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| - curremt_command : std::<span class="built_in">string</span>         |</span><br><span class="line">| - current_id : int                      |</span><br><span class="line">| - inputs : std::pmr::vector&lt;std::<span class="built_in">string</span>&gt;|</span><br><span class="line">| - count : int                           |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| + init(filename : const std::<span class="built_in">string</span>&amp;)   |</span><br><span class="line">| + hasMoreCommands() : bool              |</span><br><span class="line">| + advance() : void                      |</span><br><span class="line">| + command_type() : C_TYPE               |</span><br><span class="line">| + arg1() : std::<span class="built_in">string</span>                  |</span><br><span class="line">| + arg2() : std::<span class="built_in">string</span>                  |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br><span class="line">| enum C_TYPE                             |</span><br><span class="line">|   - C_ARITHMETIC                        |</span><br><span class="line">|   - C_PUSH                              |</span><br><span class="line">|   - C_POP                               |</span><br><span class="line">|   - C_LABEL                             |</span><br><span class="line">|   - C_GOTO                              |</span><br><span class="line">|   - C_IF                                |</span><br><span class="line">|   - C_FUNCTION                          |</span><br><span class="line">|   - C_RETRUN                            |</span><br><span class="line">|   - C_CALL                              |</span><br><span class="line">|   - C_ERROR                             |</span><br><span class="line">+<span class="comment">----------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-21.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PRASER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PRASER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Praser</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">C_TYPE</span> {</span><br><span class="line">        C_ARITHMETIC,</span><br><span class="line">        C_PUSH,</span><br><span class="line">        C_POP,</span><br><span class="line">        C_LABEL,</span><br><span class="line">        C_GOTO,</span><br><span class="line">        C_IF,</span><br><span class="line">        C_FUNCTION,</span><br><span class="line">        C_RETRUN,</span><br><span class="line">        C_CALL,</span><br><span class="line">        C_ERROR</span><br><span class="line">    };</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span></span>;</span><br><span class="line">    [[nodiscard]]<span class="function"><span class="type">bool</span> <span class="title">hasMoreCommands</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">advance</span><span class="params">()</span></span>;</span><br><span class="line">    [[nodiscard]]<span class="function">C_TYPE <span class="title">command_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">arg1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">arg2</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string curremt_command;</span><br><span class="line">    <span class="type">int</span> current_id = <span class="number">-1</span>;</span><br><span class="line">    std::pmr::vector&lt;std::string&gt; inputs;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//PRASER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-21.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Praser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Praser::init</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> </span>{</span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(filename + <span class="string">".vm"</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(!file.<span class="built_in">is_open</span>()) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! cann't find file\n"</span>;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    std::string line;</span><br><span class="line">    <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file, line)) {</span><br><span class="line">        <span class="keyword">if</span>(line.<span class="built_in">empty</span>()) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        std::string new_line;</span><br><span class="line">        std::string str;</span><br><span class="line">        <span class="type">bool</span> ok = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> ch: line) {</span><br><span class="line">            <span class="keyword">if</span>(ch != <span class="string">' '</span>) {</span><br><span class="line">                str += ch;</span><br><span class="line">                <span class="keyword">if</span>(ok == <span class="literal">false</span>) ok = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span>(ok == <span class="literal">true</span>) {</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                    new_line += str + <span class="string">';'</span>;</span><br><span class="line">                    str = <span class="string">""</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(str.<span class="built_in">empty</span>() == <span class="literal">false</span>) {</span><br><span class="line">            new_line += str;</span><br><span class="line">        }</span><br><span class="line">        <span class="type">size_t</span> pos = new_line.<span class="built_in">find</span>(<span class="string">"//"</span>);</span><br><span class="line">        <span class="keyword">if</span>(pos == std::string::npos) {</span><br><span class="line">            std::cout &lt;&lt; new_line &lt;&lt; std::endl;</span><br><span class="line">            inputs.<span class="built_in">emplace_back</span>(new_line);</span><br><span class="line">            count++;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span>(pos &gt; <span class="number">0</span>) {</span><br><span class="line">                new_line = new_line.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">                inputs.<span class="built_in">emplace_back</span>(new_line);</span><br><span class="line">                count++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Praser::hasMoreCommands</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="keyword">return</span> current_id &lt; count - <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Praser::advance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">hasMoreCommands</span>())   curremt_command = inputs[++current_id];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">Praser::C_TYPE <span class="title">Praser::command_type</span><span class="params">()</span> <span class="type">const</span></span>{</span><br><span class="line">    <span class="type">size_t</span> pos = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">    std::string str = curremt_command.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="keyword">if</span>(str == <span class="string">"add"</span> || str == <span class="string">"sub"</span> || str == <span class="string">"neg"</span> || str == <span class="string">"eq"</span> || str == <span class="string">"gt"</span> || str == <span class="string">"lt"</span> || str == <span class="string">"and"</span> || str == <span class="string">"or"</span> || str == <span class="string">"not"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_ARITHMETIC;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"pop"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_POP;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"push"</span>) {</span><br><span class="line">        <span class="keyword">return</span>  C_PUSH;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"C_TYPE: "</span> &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! C_TYPE cann't be found \n"</span>;</span><br><span class="line">        <span class="keyword">return</span> C_ERROR;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::arg1</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">command_type</span>() == C_ARITHMETIC) {</span><br><span class="line">        <span class="keyword">return</span>  curremt_command;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">command_type</span>() == C_RETRUN) {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="type">size_t</span> pos1 = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">        <span class="type">size_t</span> pos2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = pos1 + <span class="number">1</span>; i &lt; curremt_command.<span class="built_in">size</span>(); ++i) {</span><br><span class="line">            <span class="keyword">if</span>(curremt_command[i] == <span class="string">';'</span>) {</span><br><span class="line">                pos2 = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        std::string str = curremt_command.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>, pos2 - pos1 - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Praser::arg2</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">command_type</span>() == C_PUSH || <span class="built_in">command_type</span>() == C_POP || <span class="built_in">command_type</span>() == C_CALL || <span class="built_in">command_type</span>() == C_FUNCTION) {</span><br><span class="line">        <span class="type">size_t</span> pos1 = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">        <span class="type">size_t</span> pos2 = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">size_t</span> i = pos1 + <span class="number">1</span>; i &lt; curremt_command.<span class="built_in">size</span>(); ++i) {</span><br><span class="line">            <span class="keyword">if</span>(curremt_command[i] == <span class="string">';'</span>) {</span><br><span class="line">                pos2 = i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        std::string str = curremt_command.<span class="built_in">substr</span>(pos2 + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
<h3 id="codewriter-类">CodeWriter 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">--------------------------+</span></span><br><span class="line">|       CodeWriter         |</span><br><span class="line">+<span class="comment">--------------------------+</span></span><br><span class="line">| - file : std::ofstream               |</span><br><span class="line">| - staticLabel : std::<span class="built_in">string</span>          |</span><br><span class="line">| - lib : std::map&lt;std::<span class="built_in">string</span>, std::<span class="built_in">string</span>&gt; |</span><br><span class="line">| - eq_i : int                         |</span><br><span class="line">| - gt_i : int                         |</span><br><span class="line">| - lt_i : int                         |</span><br><span class="line">+<span class="comment">--------------------------+</span></span><br><span class="line">| + <span class="built_in">write</span>(filename : const std::<span class="built_in">string</span>&amp;) : void       |</span><br><span class="line">| + writeArithmetic(command_type : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">| + writePushPop(command_type : const std::<span class="built_in">string</span>&amp;, segment : const std::<span class="built_in">string</span>&amp;, index : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">| + <span class="built_in">close</span>() : void                                      |</span><br><span class="line">+<span class="comment">--------------------------+</span></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-21.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CODEWRITER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CODEWRITER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeWriter</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeArithmetic</span><span class="params">(<span class="type">const</span> std::string &amp;command_type)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writePushPop</span><span class="params">(<span class="type">const</span> std::string &amp;command_type, <span class="type">const</span> std::string &amp;segment, <span class="type">const</span> std::string &amp;index)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::ofstream file;</span><br><span class="line">    std::string staticLabel;</span><br><span class="line">    std::map&lt;std::string, std::string&gt; lib ={</span><br><span class="line">        {<span class="string">"local"</span>, <span class="string">"LCL"</span>},</span><br><span class="line">        {<span class="string">"argument"</span>, <span class="string">"ARG"</span>},</span><br><span class="line">        {<span class="string">"this"</span>, <span class="string">"THIS"</span>},</span><br><span class="line">        {<span class="string">"that"</span>, <span class="string">"THAT"</span>}</span><br><span class="line">    };</span><br><span class="line">    <span class="type">int</span> eq_i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> gt_i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> lt_i = <span class="number">0</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//CODEWRITER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-21.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"CodeWriter.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::write</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> </span>{</span><br><span class="line">    file.<span class="built_in">open</span>(filename + <span class="string">".asm"</span>);</span><br><span class="line">    <span class="type">size_t</span> pos = filename.<span class="built_in">rfind</span>(<span class="string">'/'</span>);</span><br><span class="line">    <span class="keyword">if</span>(pos != std::string::npos) {</span><br><span class="line">        staticLabel = filename.<span class="built_in">substr</span>(pos + <span class="number">1</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        staticLabel = filename;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span>(file.<span class="built_in">is_open</span>() == <span class="literal">false</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! cann't find the file"</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::close</span><span class="params">()</span> </span>{</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeArithmetic</span><span class="params">(<span class="type">const</span> std::string &amp;command_type)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(command_type == <span class="string">"add"</span>) {</span><br><span class="line">        <span class="comment">//取出两个元素，进行加法运算，最后加入到栈中</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;  <span class="comment">//更新SP</span></span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;     <span class="comment">//栈顶元素</span></span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;   <span class="comment">//第二个元素</span></span><br><span class="line">        file &lt;&lt; <span class="string">"M=D+M"</span> &lt;&lt; std::endl;   <span class="comment">//进行加法运算</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"sub"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt;<span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"neg"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"eq"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@EQ_"</span> + std::<span class="built_in">to_string</span>(eq_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JEQ"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(EQ_"</span> + std::<span class="built_in">to_string</span>(eq_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++eq_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"gt"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@GT_"</span> + std::<span class="built_in">to_string</span>(gt_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JGT"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(GT_"</span> + std::<span class="built_in">to_string</span>(gt_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++gt_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"lt"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@LT_"</span> + std::<span class="built_in">to_string</span>(lt_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JLT"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(LT_"</span> + std::<span class="built_in">to_string</span>(lt_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++lt_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"and"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D&amp;M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"or"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D|M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"not"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=!M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writePushPop</span><span class="params">(<span class="type">const</span> std::string &amp;command_type, <span class="type">const</span> std::string &amp;segment, <span class="type">const</span> std::string &amp;index)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(command_type == <span class="string">"push"</span>) {</span><br><span class="line">        <span class="keyword">if</span>(segment == <span class="string">"constant"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(lib.<span class="built_in">count</span>(segment)) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + lib[segment] &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+M"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"pointer"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"temp"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"static"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + staticLabel + <span class="string">"."</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">//error</span></span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//加入栈中，更新SP</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=M+1"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"pop"</span>) {</span><br><span class="line">        <span class="keyword">if</span>(lib.<span class="built_in">count</span>(segment)) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + lib[segment] &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"pointer"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"temp"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"static"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + staticLabel + <span class="string">"."</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//弹出栈，更新SP，需要多使用一个寄存器，不然无法实现</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="vmtranslater-类">VMtranslater 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">|       VMtranslater        |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">| - praser : Praser         |</span><br><span class="line">| - code_writer : CodeWriter|</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line">| + VMtranslater()          |</span><br><span class="line">| + convert(filename : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">+<span class="comment">---------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-22.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> VMTRANSLATER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VMTRANSLATER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Praser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"CodeWriter.h"</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VMtranslater</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">VMtranslater</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">convert</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Praser praser;</span><br><span class="line">    CodeWriter code_writer;</span><br><span class="line"></span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//VMTRANSLATER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-22.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"VMtranslater.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VMtranslater::convert</span><span class="params">(<span class="type">const</span> std::string &amp;filename)</span> </span>{</span><br><span class="line">    praser.<span class="built_in">init</span>(filename);</span><br><span class="line">    code_writer.<span class="built_in">write</span>(filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(praser.<span class="built_in">hasMoreCommands</span>()) {</span><br><span class="line">        praser.<span class="built_in">advance</span>();</span><br><span class="line">        <span class="keyword">if</span>(praser.<span class="built_in">command_type</span>() == Praser::C_ARITHMETIC) {</span><br><span class="line">            std::string arg = praser.<span class="built_in">arg1</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeArithmetic</span>(arg);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(praser.<span class="built_in">command_type</span>() == Praser::C_POP) {</span><br><span class="line">            std::string arg1 = praser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = praser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writePushPop</span>(<span class="string">"pop"</span>, arg1, arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(praser.<span class="built_in">command_type</span>() == Praser::C_PUSH) {</span><br><span class="line">            std::string arg1 = praser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = praser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writePushPop</span>(<span class="string">"push"</span>, arg1, arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            std::cerr &lt;&lt; <span class="string">"undefined C_TYPE"</span> &lt;&lt; praser.<span class="built_in">command_type</span>() &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    code_writer.<span class="built_in">close</span>();</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"finish write"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="main-1">main</h3>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"VMtranslater.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    VMtranslater my_translater;</span><br><span class="line">    std::string filename = <span class="string">"../AllTest/MemoryAccess/StaticTest/StaticTest"</span>;</span><br><span class="line">    <span class="comment">// std::cout &lt;&lt; "Please input your file name:\n";</span></span><br><span class="line">    <span class="comment">// std::cin &gt;&gt; filename;</span></span><br><span class="line">    my_translater.<span class="built_in">convert</span>(filename);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h2 id="step-8-virtual-machine-part2">Step 8 Virtual Machine Part2</h2>
<h3 id="parser-类">Parser 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">|              Parser                |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">| - twoArgs : std::map&lt;C_TYPE, std::<span class="built_in">string</span>&gt; |</span><br><span class="line">| - oneArgs : std::map&lt;C_TYPE, std::<span class="built_in">string</span>&gt; |</span><br><span class="line">| - curremt_command : std::<span class="built_in">string</span>            |</span><br><span class="line">| - inputs : std::vector&lt;std::<span class="built_in">string</span>&gt;        |</span><br><span class="line">| - current_id : int                         |</span><br><span class="line">| - count : int                              |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">| + init(filename : const fs::<span class="built_in">path</span>&amp;) : void  |</span><br><span class="line">| + reset() : void                           |</span><br><span class="line">| + hasMoreCommands() : bool                 |</span><br><span class="line">| + advance() : void                         |</span><br><span class="line">| + command_type() : C_TYPE                  |</span><br><span class="line">| + arg1() : std::<span class="built_in">string</span>                     |</span><br><span class="line">| + arg2() : std::<span class="built_in">string</span>                     |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">| enum C_TYPE                                |</span><br><span class="line">|   - C_ARITHMETIC                           |</span><br><span class="line">|   - C_PUSH                                 |</span><br><span class="line">|   - C_POP                                  |</span><br><span class="line">|   - C_LABEL                                |</span><br><span class="line">|   - C_GOTO                                 |</span><br><span class="line">|   - C_IF                                   |</span><br><span class="line">|   - C_FUNCTION                             |</span><br><span class="line">|   - C_RETRUN                               |</span><br><span class="line">|   - C_CALL                                 |</span><br><span class="line">|   - C_ERROR                                |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PARSER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PARSER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;vector&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Parser</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="keyword">enum</span> <span class="title class_">C_TYPE</span> {</span><br><span class="line">        C_ARITHMETIC,</span><br><span class="line">        C_PUSH,</span><br><span class="line">        C_POP,</span><br><span class="line">        C_LABEL,</span><br><span class="line">        C_GOTO,</span><br><span class="line">        C_IF,</span><br><span class="line">        C_FUNCTION,</span><br><span class="line">        C_RETRUN,</span><br><span class="line">        C_CALL,</span><br><span class="line">        C_ERROR</span><br><span class="line">    };</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line">    [[nodiscard]]<span class="function"><span class="type">bool</span> <span class="title">hasMoreCommands</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">advance</span><span class="params">()</span></span>;</span><br><span class="line">    [[nodiscard]]<span class="function">C_TYPE <span class="title">command_type</span><span class="params">()</span> <span class="type">const</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">arg1</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function">std::string <span class="title">arg2</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::map&lt;Parser::C_TYPE, std::string&gt; twoArgs = {</span><br><span class="line">        {C_FUNCTION, <span class="string">"C_FUNCTION"</span>},</span><br><span class="line">        {C_CALL, <span class="string">"C_CALL"</span>},</span><br><span class="line">        {C_PUSH, <span class="string">"C_PUSH"</span>},</span><br><span class="line">        {C_POP, <span class="string">"C_POP"</span>}</span><br><span class="line">    };</span><br><span class="line">    std::map&lt;Parser::C_TYPE, std::string&gt; oneArgs = {</span><br><span class="line">        {C_LABEL, <span class="string">"C_LABEL"</span>},</span><br><span class="line">        {C_GOTO, <span class="string">"C_GOTO"</span>},</span><br><span class="line">        {C_IF, <span class="string">"C_IF"</span>}</span><br><span class="line">    };</span><br><span class="line">    std::string curremt_command;</span><br><span class="line">    std::vector&lt;std::string&gt; inputs;</span><br><span class="line">    <span class="type">int</span> current_id = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//PARSER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Parser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"><span class="keyword">namespace</span> fs =std::filesystem;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::init</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span> </span>{</span><br><span class="line">    <span class="function">std::ifstream <span class="title">file</span><span class="params">(filename)</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(file.<span class="built_in">is_open</span>() == <span class="literal">false</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"cann't open "</span> &lt;&lt; filename &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    std::string line;</span><br><span class="line">    <span class="keyword">while</span>(std::<span class="built_in">getline</span>(file, line)) {</span><br><span class="line">        <span class="keyword">if</span>(line.<span class="built_in">empty</span>()) {</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        }</span><br><span class="line">        std::string new_line;</span><br><span class="line">        std::string str;</span><br><span class="line">        <span class="type">bool</span> ok = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">auto</span> ch: line) {</span><br><span class="line">            <span class="keyword">if</span>(ch == <span class="string">'\t'</span>)  <span class="keyword">continue</span>;</span><br><span class="line">            <span class="keyword">if</span>(ch != <span class="string">' '</span>) {</span><br><span class="line">                str += ch;</span><br><span class="line">                <span class="keyword">if</span>(ok == <span class="literal">false</span>) ok = <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="keyword">else</span> {</span><br><span class="line">                <span class="keyword">if</span>(ok == <span class="literal">true</span>) {</span><br><span class="line">                    ok = <span class="literal">false</span>;</span><br><span class="line">                    new_line += str + <span class="string">';'</span>;</span><br><span class="line">                    str = <span class="string">""</span>;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">if</span>(str.<span class="built_in">empty</span>() == <span class="literal">false</span>) {</span><br><span class="line">            new_line += str;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//new_line += str;</span></span><br><span class="line">        <span class="comment">//std::cout &lt;&lt; new_line &lt;&lt; std::endl;</span></span><br><span class="line">        <span class="type">size_t</span> pos = new_line.<span class="built_in">find</span>(<span class="string">"//"</span>);</span><br><span class="line">        <span class="keyword">if</span>(pos == std::string::npos) {</span><br><span class="line">            <span class="comment">// size_t pos1 = new_line.rfind(';');</span></span><br><span class="line">            <span class="comment">// if(pos1 != std::string::npos) {</span></span><br><span class="line">            <span class="comment">//     new_line = new_line.substr(0, pos1);</span></span><br><span class="line">            <span class="comment">// }</span></span><br><span class="line">            <span class="comment">//std::cout &lt;&lt; new_line &lt;&lt; std::endl;</span></span><br><span class="line">            inputs.<span class="built_in">emplace_back</span>(new_line);</span><br><span class="line">            count++;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> {</span><br><span class="line">            <span class="keyword">if</span>(pos &gt; <span class="number">0</span>) {</span><br><span class="line">                new_line = new_line.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">                <span class="type">size_t</span> pos1 = new_line.<span class="built_in">rfind</span>(<span class="string">';'</span>);</span><br><span class="line">                <span class="keyword">if</span>(pos1 != std::string::npos) {</span><br><span class="line">                    new_line = new_line.<span class="built_in">substr</span>(<span class="number">0</span>, pos1);</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">//std::cout &lt;&lt; new_line &lt;&lt; std::endl;</span></span><br><span class="line">                inputs.<span class="built_in">emplace_back</span>(new_line);</span><br><span class="line">                count++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::advance</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">hasMoreCommands</span>())   curremt_command = inputs[++current_id];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">bool</span> <span class="title">Parser::hasMoreCommands</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">    <span class="keyword">return</span> current_id &lt; count - <span class="number">1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">Parser::C_TYPE <span class="title">Parser::command_type</span><span class="params">()</span> <span class="type">const</span> </span>{</span><br><span class="line">    <span class="type">size_t</span> pos = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">    std::string str = curremt_command.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">    <span class="keyword">if</span>(str == <span class="string">"add"</span> || str == <span class="string">"sub"</span> || str == <span class="string">"neg"</span> || str == <span class="string">"eq"</span> || str == <span class="string">"gt"</span> || str == <span class="string">"lt"</span> || str == <span class="string">"and"</span> || str == <span class="string">"or"</span> || str == <span class="string">"not"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_ARITHMETIC;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"pop"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_POP;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"push"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_PUSH;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"label"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_LABEL;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"goto"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_GOTO;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"if-goto"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_IF;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"function"</span>) {</span><br><span class="line">        <span class="keyword">return</span>  C_FUNCTION;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"call"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_CALL;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(str == <span class="string">"return"</span>) {</span><br><span class="line">        <span class="keyword">return</span> C_RETRUN;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! undefined command type"</span> &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line">        <span class="keyword">return</span> C_ERROR;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Parser::arg1</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">command_type</span>() == C_ARITHMETIC) {</span><br><span class="line">        <span class="keyword">return</span>  curremt_command;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="built_in">command_type</span>() == C_RETRUN) {</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(twoArgs.<span class="built_in">count</span>(<span class="built_in">command_type</span>())){</span><br><span class="line">        <span class="type">size_t</span> pos1 = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">        <span class="type">size_t</span> pos2 = curremt_command.<span class="built_in">rfind</span>(<span class="string">';'</span>);</span><br><span class="line">        std::string str = curremt_command.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>, pos2 - pos1 - <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(oneArgs.<span class="built_in">count</span>(<span class="built_in">command_type</span>())) {</span><br><span class="line">        <span class="type">size_t</span> pos1 = curremt_command.<span class="built_in">find</span>(<span class="string">';'</span>);</span><br><span class="line">        std::string str = curremt_command.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"return undefined arg: "</span> &lt;&lt; curremt_command &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">Parser::arg2</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(twoArgs.<span class="built_in">count</span>(<span class="built_in">command_type</span>())) {</span><br><span class="line">        <span class="type">size_t</span> pos1 = curremt_command.<span class="built_in">rfind</span>(<span class="string">';'</span>);</span><br><span class="line">        std::string str = curremt_command.<span class="built_in">substr</span>(pos1 + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"return undefined arg: "</span> &lt;&lt; curremt_command &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parser::reset</span><span class="params">()</span> </span>{</span><br><span class="line">    inputs.<span class="built_in">clear</span>();</span><br><span class="line">    curremt_command = <span class="string">""</span>;</span><br><span class="line">    current_id = <span class="number">-1</span>;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="codewriter-类-1">CodeWriter 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">|            CodeWriter              |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">| - current_command : std::<span class="built_in">string</span>              |</span><br><span class="line">| - my_filename : fs::<span class="built_in">path</span>                     |</span><br><span class="line">| - file : std::ofstream                       |</span><br><span class="line">| - staticLabel : std::<span class="built_in">string</span>                  |</span><br><span class="line">| - lib : std::map&lt;std::<span class="built_in">string</span>, std::<span class="built_in">string</span>&gt;   |</span><br><span class="line">| - eq_i : int                                 |</span><br><span class="line">| - gt_i : int                                 |</span><br><span class="line">| - lt_i : int                                 |</span><br><span class="line">| - addr_i : int                               |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line">| + setFileName(filename : const fs::<span class="built_in">path</span>&amp;) : void                    |</span><br><span class="line">| + <span class="built_in">write</span>(filename : const fs::<span class="built_in">path</span>&amp;) : void                          |</span><br><span class="line">| + writeArithmetic(command_type : const std::<span class="built_in">string</span>&amp;) : void         |</span><br><span class="line">| + writePushPop(command_type : const std::<span class="built_in">string</span>&amp;, segment : const std::<span class="built_in">string</span>&amp;, index : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">| + writeLabel(label : const std::<span class="built_in">string</span>&amp;) : void                     |</span><br><span class="line">| + writeGoto(label : const std::<span class="built_in">string</span>&amp;) : void                      |</span><br><span class="line">| + writeIf(label : const std::<span class="built_in">string</span>&amp;) : void                        |</span><br><span class="line">| + writeCall(function_name : const std::<span class="built_in">string</span>&amp;, numArgs : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">| + writeReturn() : void                                              |</span><br><span class="line">| + writeFunction(function_name : const std::<span class="built_in">string</span>&amp;, numArgs : const std::<span class="built_in">string</span>&amp;) : void |</span><br><span class="line">| + <span class="built_in">close</span>() : void                                                    |</span><br><span class="line">| - saveCaller(segement : const std::<span class="built_in">string</span>&amp;) : void                  |</span><br><span class="line">| - bootStrap() : void                                                |</span><br><span class="line">+<span class="comment">------------------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CODEWRITER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CODEWRITER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;map&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fstream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CodeWriter</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">setFileName</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">write</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeArithmetic</span><span class="params">(<span class="type">const</span> std::string &amp;command_type)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writePushPop</span><span class="params">(<span class="type">const</span> std::string &amp;command_type, <span class="type">const</span> std::string &amp;segment, <span class="type">const</span> std::string &amp;index)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeLabel</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeGoto</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeIf</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeCall</span><span class="params">(<span class="type">const</span> std::string &amp;function_name, <span class="type">const</span> std::string &amp;numArgs)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeReturn</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">writeFunction</span><span class="params">(<span class="type">const</span> std::string &amp;function_name, <span class="type">const</span> std::string &amp;numArgs)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">close</span><span class="params">()</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    std::string current_command;</span><br><span class="line">    fs::path my_filename;</span><br><span class="line">    std::ofstream file;</span><br><span class="line">    std::string staticLabel;</span><br><span class="line">    std::map&lt;std::string, std::string&gt; lib ={</span><br><span class="line">        {<span class="string">"local"</span>, <span class="string">"LCL"</span>},</span><br><span class="line">        {<span class="string">"argument"</span>, <span class="string">"ARG"</span>},</span><br><span class="line">        {<span class="string">"this"</span>, <span class="string">"THIS"</span>},</span><br><span class="line">        {<span class="string">"that"</span>, <span class="string">"THAT"</span>}</span><br><span class="line">    };</span><br><span class="line">    <span class="type">int</span> eq_i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> gt_i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> lt_i = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span> addr_i = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">saveCaller</span><span class="params">(<span class="type">const</span> std::string &amp;segement)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">bootStrap</span><span class="params">()</span></span>;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//CODEWRITER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"CodeWriter.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::bootStrap</span><span class="params">()</span> </span>{</span><br><span class="line">    file.<span class="built_in">open</span>(my_filename, std::ios::app);</span><br><span class="line">    file &lt;&lt; <span class="string">"@256"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@1"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@LCL"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@2"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@ARG"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@THIS"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@4"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@THAT"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">writeCall</span>(<span class="string">"Sys.init"</span>, <span class="string">"0"</span>);</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::setFileName</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(filename.<span class="built_in">has_extension</span>()) {</span><br><span class="line">        std::string str = filename.<span class="built_in">generic_string</span>();</span><br><span class="line">        <span class="type">size_t</span> pos = str.<span class="built_in">rfind</span>(<span class="string">'.'</span>);</span><br><span class="line">        <span class="keyword">this</span> -&gt; my_filename = str.<span class="built_in">substr</span>(<span class="number">0</span>, pos);</span><br><span class="line">        my_filename += <span class="string">".asm"</span>;</span><br><span class="line">        <span class="comment">//std::cerr &lt;&lt; "file name: " &lt;&lt; my_filename &lt;&lt; std::endl;</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="keyword">this</span> -&gt; my_filename = filename;</span><br><span class="line">        my_filename += <span class="string">".asm"</span>;</span><br><span class="line">        <span class="comment">//std::cerr &lt;&lt; "file name: " &lt;&lt; my_filename &lt;&lt; std::endl;</span></span><br><span class="line">        <span class="built_in">bootStrap</span>();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::write</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span> </span>{</span><br><span class="line">    file.<span class="built_in">open</span>(my_filename, std::ios::app);</span><br><span class="line">    staticLabel = filename.<span class="built_in">stem</span>().<span class="built_in">generic_string</span>();</span><br><span class="line">    std::cout &lt;&lt; staticLabel &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">if</span>(file.<span class="built_in">is_open</span>() == <span class="literal">false</span>) {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! cann't find the file: "</span> &lt;&lt; my_filename &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::close</span><span class="params">()</span> </span>{</span><br><span class="line">    file.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeArithmetic</span><span class="params">(<span class="type">const</span> std::string &amp;command_type)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(command_type == <span class="string">"add"</span>) {</span><br><span class="line">        <span class="comment">//取出两个元素，进行加法运算，最后加入到栈中</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;  <span class="comment">//更新SP</span></span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;     <span class="comment">//栈顶元素</span></span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;   <span class="comment">//第二个元素</span></span><br><span class="line">        file &lt;&lt; <span class="string">"M=D+M"</span> &lt;&lt; std::endl;   <span class="comment">//进行加法运算</span></span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"sub"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"neg"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"eq"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@EQ_"</span> + std::<span class="built_in">to_string</span>(eq_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JEQ"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(EQ_"</span> + std::<span class="built_in">to_string</span>(eq_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++eq_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"gt"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@GT_"</span> + std::<span class="built_in">to_string</span>(gt_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JGT"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(GT_"</span> + std::<span class="built_in">to_string</span>(gt_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++gt_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"lt"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@LT_"</span> + std::<span class="built_in">to_string</span>(lt_i) &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D;JLT"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"(LT_"</span> + std::<span class="built_in">to_string</span>(lt_i) + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">        ++lt_i;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"and"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D&amp;M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"or"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=A-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D|M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"not"</span>) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=!M"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writePushPop</span><span class="params">(<span class="type">const</span> std::string &amp;command_type, <span class="type">const</span> std::string &amp;segment, <span class="type">const</span> std::string &amp;index)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(command_type == <span class="string">"push"</span>) {</span><br><span class="line">        <span class="keyword">if</span>(segment == <span class="string">"constant"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(lib.<span class="built_in">count</span>(segment)) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + lib[segment] &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+M"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"pointer"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"temp"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"A=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"static"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + staticLabel + <span class="string">"."</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"address"</span>){</span><br><span class="line">            file &lt;&lt; <span class="string">"@RA_"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//加入栈中，更新SP</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=M+1"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(command_type == <span class="string">"pop"</span>) {</span><br><span class="line">        <span class="keyword">if</span>(lib.<span class="built_in">count</span>(segment)) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + lib[segment] &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+M"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"pointer"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"temp"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(segment == <span class="string">"static"</span>) {</span><br><span class="line">            file &lt;&lt; <span class="string">"@"</span> + staticLabel + <span class="string">"."</span> + index &lt;&lt; std::endl;</span><br><span class="line">            file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">//弹出栈，更新SP，需要多使用一个寄存器，不然无法实现</span></span><br><span class="line">        file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeGoto</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"//"</span> + label &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@"</span> + label &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"0;JMP"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeIf</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"//if-goto "</span> + label &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@"</span> + label &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D;JNE"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeLabel</span><span class="params">(<span class="type">const</span> std::string &amp;label)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"//"</span> + label &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"("</span> + label  + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeReturn</span><span class="params">()</span> </span>{</span><br><span class="line">    <span class="comment">//FRAME=LCL，FRAME是临时变量：这里使用R13进行表示</span></span><br><span class="line">    file &lt;&lt; <span class="string">"@LCL"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//RET=*(FRAME-5)，RET是临时变量，这里使用R14进行表示</span></span><br><span class="line">    file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R14"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//或写作</span></span><br><span class="line">    <span class="comment">// file &lt;&lt; "@5" &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// file &lt;&lt; "A=D-A" &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// file &lt;&lt; "D=M" &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// file &lt;&lt; "@R14" &lt;&lt; std::endl;</span></span><br><span class="line">    <span class="comment">// file &lt;&lt; "M=D" &lt;&lt; std::endl;</span></span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"AM=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@ARG"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@ARG"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D+1"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M-1"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@THAT"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@2"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@THIS"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@3"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@ARG"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@4"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@R13"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@LCL"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    file &lt;&lt; <span class="string">"@R14"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"0;JMP"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeCall</span><span class="params">(<span class="type">const</span> std::string &amp;function_name, <span class="type">const</span> std::string &amp;numArgs)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"//writeCall: "</span> + function_name + <span class="string">": "</span> +numArgs &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">writePushPop</span>(<span class="string">"push"</span>, <span class="string">"address"</span>, std::<span class="built_in">to_string</span>(addr_i));</span><br><span class="line">    <span class="built_in">saveCaller</span>(<span class="string">"LCL"</span>);</span><br><span class="line">    <span class="built_in">saveCaller</span>(<span class="string">"ARG"</span>);</span><br><span class="line">    <span class="built_in">saveCaller</span>(<span class="string">"THIS"</span>);</span><br><span class="line">    <span class="built_in">saveCaller</span>(<span class="string">"THAT"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ARG=SP-n-5</span></span><br><span class="line">    file &lt;&lt; <span class="string">"//ARG=SP-"</span> + numArgs +<span class="string">"-5"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@"</span> + numArgs &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@5"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=D+A"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M-D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@ARG"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//LCL=SP</span></span><br><span class="line">    file &lt;&lt; <span class="string">"//LCL=SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@LCL"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//goto f</span></span><br><span class="line">    <span class="comment">//(return-address)</span></span><br><span class="line">    file &lt;&lt; <span class="string">"//goto "</span> + function_name &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"//return_address: "</span> + std::<span class="built_in">to_string</span>(addr_i) &lt;&lt; std::endl;</span><br><span class="line">    <span class="built_in">writeGoto</span>(function_name);</span><br><span class="line">    <span class="built_in">writeLabel</span>(<span class="string">"RA_"</span> + std::<span class="built_in">to_string</span>(addr_i));</span><br><span class="line">    addr_i++;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::writeFunction</span><span class="params">(<span class="type">const</span> std::string &amp;function_name, <span class="type">const</span> std::string &amp;numArgs)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"//function "</span> + function_name + <span class="string">": "</span> + numArgs &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"("</span> + function_name + <span class="string">")"</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="type">int</span> nArgs = std::<span class="built_in">stoi</span>(numArgs);</span><br><span class="line">    file &lt;&lt; <span class="string">"// Push nArgs: initialize 0"</span> &lt;&lt; std::endl;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; nArgs; ++i) {</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=0"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">        file &lt;&lt; <span class="string">"M=M+1"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">CodeWriter::saveCaller</span><span class="params">(<span class="type">const</span> std::string &amp;segement)</span> </span>{</span><br><span class="line">    file &lt;&lt; <span class="string">"@"</span> + segement &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"D=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"A=M"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=D"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"@SP"</span> &lt;&lt; std::endl;</span><br><span class="line">    file &lt;&lt; <span class="string">"M=M+1"</span> &lt;&lt; std::endl;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="vmtranslater-类-1">VMtranslater 类</h3>
<figure class="highlight lua"><table><tbody><tr><td class="code"><pre><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">|          VMtranslater         |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| - parser : Parser             |</span><br><span class="line">| - code_writer : CodeWriter    |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line">| + VMtranslater()              |</span><br><span class="line">| + init(filename : const fs::<span class="built_in">path</span>&amp;) : void |</span><br><span class="line">| + convert(filename : const fs::<span class="built_in">path</span>&amp;) : void |</span><br><span class="line">+<span class="comment">-------------------------------+</span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> VMTRANSLATER_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> VMTRANSLATER_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"Parser.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"CodeWriter.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;filesystem&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VMtranslater</span> {</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">VMtranslater</span>() = <span class="keyword">default</span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">init</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span></span>;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">convert</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span></span>;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    Parser parser;</span><br><span class="line">    CodeWriter code_writer;</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//VMTRANSLATER_H</span></span></span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by APP on 24-10-23.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"VMtranslater.h"</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VMtranslater::init</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(fs::<span class="built_in">exists</span>(filename)) {</span><br><span class="line">        <span class="keyword">if</span>(fs::<span class="built_in">is_regular_file</span>(filename)) {</span><br><span class="line">            <span class="keyword">if</span>(filename.<span class="built_in">extension</span>() == <span class="string">".vm"</span>) {</span><br><span class="line">                code_writer.<span class="built_in">setFileName</span>(filename);</span><br><span class="line">                <span class="built_in">convert</span>(filename);</span><br><span class="line">                std::cout &lt;&lt; <span class="string">"finish file"</span> &lt;&lt; std::endl;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(fs::<span class="built_in">is_directory</span>(filename)) {</span><br><span class="line">            code_writer.<span class="built_in">setFileName</span>(filename);</span><br><span class="line">            <span class="type">int</span> count = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; entry: fs::<span class="built_in">directory_iterator</span>(filename)) {</span><br><span class="line">                <span class="keyword">if</span>(entry.<span class="built_in">path</span>().<span class="built_in">extension</span>() == <span class="string">".vm"</span>) {</span><br><span class="line">                    <span class="built_in">convert</span>(entry.<span class="built_in">path</span>());</span><br><span class="line">                    std::cout &lt;&lt; <span class="string">"finish Dictionary: file "</span> &lt;&lt; ++count &lt;&lt; std::endl;</span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">            std::cout &lt;&lt; <span class="string">"finish all files: "</span> &lt;&lt; count &lt;&lt; std::endl;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        std::cerr &lt;&lt; <span class="string">"error! cann't find '.vm' file"</span> &lt;&lt; std::endl;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">VMtranslater::convert</span><span class="params">(<span class="type">const</span> fs::path &amp;filename)</span> </span>{</span><br><span class="line">    parser.<span class="built_in">reset</span>();</span><br><span class="line">    parser.<span class="built_in">init</span>(filename);</span><br><span class="line">    code_writer.<span class="built_in">write</span>(filename);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(parser.<span class="built_in">hasMoreCommands</span>()) {</span><br><span class="line">        parser.<span class="built_in">advance</span>();</span><br><span class="line">        <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_ARITHMETIC) {</span><br><span class="line">            std::string arg = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeArithmetic</span>(arg);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_POP) {</span><br><span class="line">            std::string arg1 = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = parser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writePushPop</span>(<span class="string">"pop"</span>, arg1, arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_PUSH) {</span><br><span class="line">            std::string arg1 = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = parser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writePushPop</span>(<span class="string">"push"</span>, arg1, arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_IF) {</span><br><span class="line">            std::string label = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeIf</span>(label);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_LABEL) {</span><br><span class="line">            std::string label = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeLabel</span>(label);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_GOTO) {</span><br><span class="line">            std::string label = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeGoto</span>(label);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_FUNCTION) {</span><br><span class="line">            std::string arg1 = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = parser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeFunction</span>(arg1,arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_CALL) {</span><br><span class="line">            std::string arg1 = parser.<span class="built_in">arg1</span>();</span><br><span class="line">            std::string arg2 = parser.<span class="built_in">arg2</span>();</span><br><span class="line">            code_writer.<span class="built_in">writeCall</span>(arg1,arg2);</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(parser.<span class="built_in">command_type</span>() == Parser::C_RETRUN) {</span><br><span class="line">            code_writer.<span class="built_in">writeReturn</span>();</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    code_writer.<span class="built_in">close</span>();</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<h3 id="main-2">main</h3>
<figure class="highlight cpp"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"VMtranslater.h"</span></span></span><br><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    VMtranslater my_translater;</span><br><span class="line">    <span class="function">fs::path <span class="title">input_path</span><span class="params">(<span class="string">"../AllTest/FunctionCalls/StaticsTest"</span>)</span></span>;</span><br><span class="line">    my_translater.<span class="built_in">init</span>(input_path);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></tbody></table></figure>
<p>剩余的两个部分是编译器和操作系统，寒假再搞。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://www.heavenhold.cn">马洛</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://www.heavenhold.cn/posts/b6a9f85a.html">https://www.heavenhold.cn/posts/b6a9f85a.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="external nofollow noreferrer" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.heavenhold.cn" target="_blank">Heavenhold</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/">计算机体系结构</a></div><div class="post_share"><div class="social-share" data-image="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410072124051.webp" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/sharejs/dist/js/social-share.min.js" defer=""></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/dd378ae0.html" title="CS106L"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410072124946.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">CS106L</div></div></a></div><div class="next-post pull-right"><a href="/posts/8c0262e2.html" title="20241008"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://cdn.jsdelivr.net/gh/BomLook/cartoon@main/img/202410101617629.webp" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">20241008</div></div></a></div></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BA%E8%AE%A1%E7%AE%97%E6%9C%BA"><span class="toc-number">1.</span> <span class="toc-text">从零开始搭建计算机</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#step-1-logic-gate"><span class="toc-number">1.1.</span> <span class="toc-text">Step 1 Logic Gate</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#not"><span class="toc-number">1.1.1.</span> <span class="toc-text">Not</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#and"><span class="toc-number">1.1.2.</span> <span class="toc-text">And</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#or"><span class="toc-number">1.1.3.</span> <span class="toc-text">Or</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#xor"><span class="toc-number">1.1.4.</span> <span class="toc-text">Xor</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mux"><span class="toc-number">1.1.5.</span> <span class="toc-text">Mux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dmux"><span class="toc-number">1.1.6.</span> <span class="toc-text">DMux</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#not16"><span class="toc-number">1.1.7.</span> <span class="toc-text">Not16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#and16"><span class="toc-number">1.1.8.</span> <span class="toc-text">And16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#or16"><span class="toc-number">1.1.9.</span> <span class="toc-text">Or16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mux16"><span class="toc-number">1.1.10.</span> <span class="toc-text">Mux16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#or8way"><span class="toc-number">1.1.11.</span> <span class="toc-text">Or8Way</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mux4way16"><span class="toc-number">1.1.12.</span> <span class="toc-text">Mux4Way16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mux8way16"><span class="toc-number">1.1.13.</span> <span class="toc-text">Mux8Way16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dmux4way16"><span class="toc-number">1.1.14.</span> <span class="toc-text">DMux4Way16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dmux8way"><span class="toc-number">1.1.15.</span> <span class="toc-text">DMux8Way</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-2-a-simple-alu"><span class="toc-number">1.2.</span> <span class="toc-text">Step 2 A Simple ALU</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#halfadder"><span class="toc-number">1.2.1.</span> <span class="toc-text">HalfAdder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fulladder"><span class="toc-number">1.2.2.</span> <span class="toc-text">FullAdder</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#add16"><span class="toc-number">1.2.3.</span> <span class="toc-text">Add16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inc16"><span class="toc-number">1.2.4.</span> <span class="toc-text">Inc16</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#alu"><span class="toc-number">1.2.5.</span> <span class="toc-text">ALU</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-3-memory"><span class="toc-number">1.3.</span> <span class="toc-text">Step 3 Memory</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bit"><span class="toc-number">1.3.1.</span> <span class="toc-text">Bit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#register"><span class="toc-number">1.3.2.</span> <span class="toc-text">Register</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ram8"><span class="toc-number">1.3.3.</span> <span class="toc-text">RAM8</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ram64"><span class="toc-number">1.3.4.</span> <span class="toc-text">RAM64</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ram512"><span class="toc-number">1.3.5.</span> <span class="toc-text">RAM512</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ram4k"><span class="toc-number">1.3.6.</span> <span class="toc-text">RAM4K</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ram16k"><span class="toc-number">1.3.7.</span> <span class="toc-text">RAM16K</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pc"><span class="toc-number">1.3.8.</span> <span class="toc-text">PC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-4-machine-language"><span class="toc-number">1.4.</span> <span class="toc-text">Step 4 Machine Language</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-5-hack-computer"><span class="toc-number">1.5.</span> <span class="toc-text">Step 5 Hack Computer</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#memory"><span class="toc-number">1.5.1.</span> <span class="toc-text">Memory</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#computer"><span class="toc-number">1.5.2.</span> <span class="toc-text">Computer</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cpu"><span class="toc-number">1.5.3.</span> <span class="toc-text">CPU</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-6-assembler"><span class="toc-number">1.6.</span> <span class="toc-text">Step 6 Assembler</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#code-%E7%B1%BB"><span class="toc-number">1.6.1.</span> <span class="toc-text">Code 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#symboltable-%E7%B1%BB"><span class="toc-number">1.6.2.</span> <span class="toc-text">SymbolTable 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#praser-%E7%B1%BB"><span class="toc-number">1.6.3.</span> <span class="toc-text">Praser 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#test-%E7%B1%BB"><span class="toc-number">1.6.4.</span> <span class="toc-text">test 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main"><span class="toc-number">1.6.5.</span> <span class="toc-text">main</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-7-virtual-machine-part1"><span class="toc-number">1.7.</span> <span class="toc-text">Step 7 Virtual machine Part1</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#praser-%E7%B1%BB-1"><span class="toc-number">1.7.1.</span> <span class="toc-text">Praser 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codewriter-%E7%B1%BB"><span class="toc-number">1.7.2.</span> <span class="toc-text">CodeWriter 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vmtranslater-%E7%B1%BB"><span class="toc-number">1.7.3.</span> <span class="toc-text">VMtranslater 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main-1"><span class="toc-number">1.7.4.</span> <span class="toc-text">main</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#step-8-virtual-machine-part2"><span class="toc-number">1.8.</span> <span class="toc-text">Step 8 Virtual Machine Part2</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#parser-%E7%B1%BB"><span class="toc-number">1.8.1.</span> <span class="toc-text">Parser 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#codewriter-%E7%B1%BB-1"><span class="toc-number">1.8.2.</span> <span class="toc-text">CodeWriter 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vmtranslater-%E7%B1%BB-1"><span class="toc-number">1.8.3.</span> <span class="toc-text">VMtranslater 类</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#main-2"><span class="toc-number">1.8.4.</span> <span class="toc-text">main</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">©2024 By 马洛</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener external nofollow noreferrer" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js?v=4.13.0"></script><script src="/js/main.js?v=4.13.0"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0.33/dist/fancybox/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload@17.8.8/dist/lazyload.iife.min.js"></script><script src="https://cdn.jsdelivr.net/npm/node-snackbar@0.1.16/dist/snackbar.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css"><script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/copy-tex.min.js"></script><script>(() => {
  document.querySelectorAll('#article-container span.katex-display').forEach(item => {
    btf.wrap(item, 'div', { class: 'katex-wrap'})
  })
})()</script></div><canvas id="universe"></canvas><script defer="" src="/js/universe.js"></script><script id="canvas_nest" defer="defer" color="255,215,0" opacity="0.7" zindex="-1" count="99" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/canvas-nest.min.js"></script><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1.1.3/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = true;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async="" data-pjax="" src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"></div></div><hr><div id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="/js/search/local-search.js?v=4.13.0"></script></div></div><!-- hexo injector body_end start --> <script data-pjax="">if(document.getElementById('recent-posts') && location.pathname =='/'){
    
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="height: auto;width: 100%"><div class="blog-slider swiper-container-fade swiper-container-horizontal" id="swiper_container"><div class="blog-slider__wrp swiper-wrapper" style="transition-duration: 0ms"><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://www.horosama.com/api/image_all/anime/1080p/pc/42c08c785C5135E69a77870D477AFAD0.jpg" alt="https://www.horosama.com/api/image_all/anime/1080p/pc/42c08c785C5135E69a77870D477AFAD0.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-05-04</span><a class="blog-slider__title" href="posts/2a942d0f.html">刷题计划</a><div class="blog-slider__text">不定期更新题单和内容</div><a class="blog-slider__button" href="posts/2a942d0f.html">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://npm.elemecdn.com/ushio-api-img-moe@5.0.56/img_561_849x1200_96_null_normal.jpg" alt="https://npm.elemecdn.com/ushio-api-img-moe@5.0.56/img_561_849x1200_96_null_normal.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-04-03</span><a class="blog-slider__title" href="posts/a7d34c04.html">A Way to Practice Competitive Programming</a><div class="blog-slider__text">迷茫的时候就看看吧</div><a class="blog-slider__button" href="posts/a7d34c04.html">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://npm.elemecdn.com/ushio-api-img-moe@5.0.16/img_160_1486x897_143.992599487305_null_normal.jpg" alt="https://npm.elemecdn.com/ushio-api-img-moe@5.0.16/img_160_1486x897_143.992599487305_null_normal.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-04-02</span><a class="blog-slider__title" href="posts/7d68f443.html">Plan</a><div class="blog-slider__text">不定期更新</div><a class="blog-slider__button" href="posts/7d68f443.html">详情</a></div></div><div class="blog-slider__item swiper-slide" style="width: 750px; opacity: 1; transform: translate3d(0px, 0px, 0px); transition-duration: 0ms"><div class="blog-slider__img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgdmlld0JveD0iMCAwIDI0IDI0Ij48Y2lyY2xlIGN4PSI0IiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgaWQ9InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAiIGF0dHJpYnV0ZU5hbWU9InIiIGJlZ2luPSIwO3N2Z1NwaW5uZXJzM0RvdHNTY2FsZTEuZW5kLTAuMjVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjMiIGZpbGw9ImN1cnJlbnRDb2xvciI+PGFuaW1hdGUgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNnMiIGR1cj0iMC43NXMiIHZhbHVlcz0iMzsuMjszIi8+PC9jaXJjbGU+PGNpcmNsZSBjeD0iMjAiIGN5PSIxMiIgcj0iMyIgZmlsbD0iY3VycmVudENvbG9yIj48YW5pbWF0ZSBpZD0ic3ZnU3Bpbm5lcnMzRG90c1NjYWxlMSIgYXR0cmlidXRlTmFtZT0iciIgYmVnaW49InN2Z1NwaW5uZXJzM0RvdHNTY2FsZTAuZW5kLTAuNDVzIiBkdXI9IjAuNzVzIiB2YWx1ZXM9IjM7LjI7MyIvPjwvY2lyY2xlPjwvc3ZnPg==" data-original="https://npm.elemecdn.com/ushio-api-img-moe@5.0.3/img_31_2560x1440_72_null_normal.jpg" alt="https://npm.elemecdn.com/ushio-api-img-moe@5.0.3/img_31_2560x1440_72_null_normal.jpg"/></div><div class="blog-slider__content"><span class="blog-slider__code">2024-04-02</span><a class="blog-slider__title" href="posts/f39cb498.html">诸子百家</a><div class="blog-slider__text">追寻前人的路</div><a class="blog-slider__button" href="posts/f39cb498.html">详情</a></div></div></div><div class="blog-slider__pagination swiper-pagination-clickable swiper-pagination-bullets"></div></div></div>';
    console.log('已挂载swiper')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script>
<script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper/swiper/swiper.min.js"></script>
<script data-pjax="" src="https://cdn.jsdelivr.net/gh/Zfour/Butterfly-swiper@0.18/swiper/swiperindex.js"></script>
<style></style><!-- hexo injector body_end end -->
        <style>
            [bg-lazy] {
                background-image: none !important;
                background-color: #eee !important;
            }
        </style>
        <script>
            window.imageLazyLoadSetting = {
                isSPA: false,
                preloadRatio: 1,
                processImages: null,
            };
        </script><script>window.addEventListener("load",function(){var t=/\.(gif|jpg|jpeg|tiff|png)$/i,r=/^data:image\/[a-z]+;base64,/;Array.prototype.slice.call(document.querySelectorAll("img[data-original]")).forEach(function(a){var e=a.parentNode;"A"===e.tagName&&(e.href.match(t)||e.href.match(r))&&(e.href=a.dataset.original)})});</script><script>!function(r){r.imageLazyLoadSetting.processImages=t;var a=r.imageLazyLoadSetting.isSPA,n=r.imageLazyLoadSetting.preloadRatio||1,d=o();function o(){var t=Array.prototype.slice.call(document.querySelectorAll("img[data-original]")),e=Array.prototype.slice.call(document.querySelectorAll("[bg-lazy]"));return t.concat(e)}function t(t){(a||t)&&(d=o());for(var e,i=0;i<d.length;i++)0<=(e=(e=d[i]).getBoundingClientRect()).bottom&&0<=e.left&&e.top<=(r.innerHeight*n||document.documentElement.clientHeight*n)&&function(){var t,e,a,n,o=d[i];e=function(){d=d.filter(function(t){return o!==t}),r.imageLazyLoadSetting.onImageLoaded&&r.imageLazyLoadSetting.onImageLoaded(o)},(t=o).dataset.loaded||(t.hasAttribute("bg-lazy")?(t.removeAttribute("bg-lazy"),e&&e()):(a=new Image,n=t.getAttribute("data-original"),a.onload=function(){t.src=n,t.removeAttribute("data-original"),t.setAttribute("data-loaded",!0),e&&e()},a.onerror=function(){t.removeAttribute("data-original"),t.setAttribute("data-loaded",!1),t.src=n},t.src!==n&&(a.src=n)))}()}function e(){clearTimeout(t.tId),t.tId=setTimeout(t,500)}t(),document.addEventListener("scroll",e),r.addEventListener("resize",e),r.addEventListener("orientationchange",e)}(this);</script></body></html>